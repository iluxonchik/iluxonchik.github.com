<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Programming, Security and Related &#8211; The Codeumentary</title>
<meta name="description" content="Software development, security and other computer related topics. Blog written by Illya Gerasymchuk.">
<meta name="keywords" content="programming, software development, security, cryptography">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://iluxonchik.github.io/images/miami_night_bridge.jpg">

<meta name="twitter:title" content="Programming, Security and Related">
<meta name="twitter:description" content="Software development, security and other computer related topics. Blog written by Illya Gerasymchuk.">
<meta name="twitter:creator" content="@iluxonchik">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Programming, Security and Related">
<meta property="og:description" content="Software development, security and other computer related topics. Blog written by Illya Gerasymchuk.">
<meta property="og:url" content="https://iluxonchik.github.io/">
<meta property="og:site_name" content="The Codeumentary">





<link rel="canonical" href="https://iluxonchik.github.io/">
<link href="https://iluxonchik.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="The Codeumentary Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://iluxonchik.github.io/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="https://iluxonchik.github.io/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://iluxonchik.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://iluxonchik.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://iluxonchik.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://iluxonchik.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://iluxonchik.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://iluxonchik.github.io/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="https://iluxonchik.github.io/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="https://iluxonchik.github.io/images/avatar.jpg" alt="Illya Gerasymchuk photo" class="author-photo">
					<h4>Illya Gerasymchuk</h4>
					<p>Software Engineer at Mercedes-Benz.io</p>
				</li>
				<li><a href="https://iluxonchik.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:illya@iluxonchik.me"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/iluxonchik"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				
				<li>
					<a href="https://linkedin.com/in/iluxonchik"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/iluxonchik"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				<li>
					<a href="https://instagram.com/iluxonchik.meow"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="https://iluxonchik.github.io/posts/">All Posts</a></li>
				<li><a href="https://iluxonchik.github.io/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="https://iluxonchik.github.io/images/miami_night_bridge.jpg" alt="Programming, Security and Related">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>The Codeumentary</h1>
      <h2>Programming, Security and Related</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2018-05-13T17:00:03+01:00"><a href="https://iluxonchik.github.io/chave-movel-digital-does-not-log-out/">May 13, 2018</a></time></span><span class="author vcard"><span class="fn"><a href="https://iluxonchik.github.io/about/" title="About Illya Gerasymchuk">Illya Gerasymchuk</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~2 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://iluxonchik.github.io/chave-movel-digital-does-not-log-out/" rel="bookmark" title="Chave Móvel Digital's Log Out Button Does Not Log The User Out" itemprop="url">Chave Móvel Digital's Log Out Button Does Not Log The User Out</a></h1>
    
  </header>
  <div class="entry-content">
    <ul>
  <li><a href="/weak-security-of-portuguese-government/">Part 1 - The Weak Security Of The Portuguese Government’s Authentication System</a></li>
  <li><a href="/chave-movel-digital-xss">Part 2 - Chave Móvel Digital Multiple XSS Vulnerabilites</a></li>
  <li><a href="/chave-movel-digital-phone-number-information-leakage">Part 3 - Chave Móvel Digital Phone Number Leakage</a></li>
  <li><strong>Part 4 - Chave Móvel Digital Log Out Not Working</strong></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>In this blog post I will show you that the “Log Out” button does
not actually log the user out.</p>

<h1 id="the-log-out-button-does-not-log-you-out">The Log Out Button Does Not Log You Out</h1>

<p>If you click on “Sair”, which translates to “Log Out” you’re not
actually logged out. It doesn’t matter if you try to login straight away,
try to login in a new tab or try to login in a new window. The only
way to actually log out is to close the browser and open it again.</p>

<p>The video below demonstrates the issue in action.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/f5I1wwP0_UM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen=""></iframe>

<p>I’ve tested this in Google Chrome on Android and the problem was present
there too. This is an issue. Let’s say that the user logs on a device that’s
not his. After he’s finished with his tasks he clicks on “Log Out”,
thinking that his session has been terminated. This means that the
attacker can simply open the website, click on “Log In” and
obtain access to the victim’s account.</p>

<p>A little bit of exploring reveled the problem. The only think that
clicking “Log Out” does is redirecting the user’s browser to
<code class="highlighter-rouge">https://www.autenticacao.gov.pt/c/portal/logout</code>. This page, in turn,
redirects the user back to the home page and sets some
cookies to an empty string, namely <code class="highlighter-rouge">COMPANY_ID</code>, <code class="highlighter-rouge">ID</code>, <code class="highlighter-rouge">LOGIN</code>, <code class="highlighter-rouge">PASSWORD</code> and
<code class="highlighter-rouge">REMEMBER ME</code>. I’m not sure what they are, since I haven’t seen them
used anywhere else on the site. I assume it’s some code that was ported
for somewhere, but was never adjusted to a different authentication
mechanism (I just hope they weren’t storing the password in plain text
there).</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> Cookies Set By The Log Out Page</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/logout_cookies.png" alt="Cookies Set By The Log Out Page" /></td></tr>
</table>

<p>What the page fails to do, is clean the <code class="highlighter-rouge">ASPXAUTH</code> and <code class="highlighter-rouge">ASP.Net_SessionId</code>
cookies. In <code class="highlighter-rouge">ASP.NET</code> <code class="highlighter-rouge">ASPXAUTH</code> is a cookie used to identity if the user is
authenticated and the <code class="highlighter-rouge">ASP.Net_SessionId</code> is a cookie used to identify the
user’s session on the server.</p>

<p>Those cookie’s expiration date is not set, which means that they will have
the life time of a session cookie,  meaning that they will get removed once
the client is shut down. This explains why closing and opening the browser
again actually logs the user out.</p>

<p>The solution to this problem is to simply clear the <code class="highlighter-rouge">ASPXAUTH</code> and <code class="highlighter-rouge">ASP.Net_SessionId</code> on the log out page.</p>

<h1 id="conclusion">Conclusion</h1>

<p>In this blog post I demonstrated that the “Log Out” button does not actually
log the user out, since it fails to clean the authentication cookie.
This opens a window to unauthorized account access.</p>

<p>This blog post ends the series of blog posts related to the security
weaknesses and vulnerabilities found in the Portuguese government’s
authentication system <code class="highlighter-rouge">autenticacao.gov.pt</code> and <em>Chave Móvel Digital</em>.
The issues described throughout these blog posts were not a result of a
thorough analysis, but rather what I found in about 30 minutes.
This leads me to believe that a more detailed study of the system’s
security is likely to reveal many more problems.</p>

<p>I hope that the described issues will be fixed very soon,
since they put millions of Portuguese citizens at risk. The agency
responsible for these systems should take security more seriously
and not as an afterthought.</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2018-05-13T17:00:02+01:00"><a href="https://iluxonchik.github.io/chave-movel-digital-phone-number-information-leakage/">May 13, 2018</a></time></span><span class="author vcard"><span class="fn"><a href="https://iluxonchik.github.io/about/" title="About Illya Gerasymchuk">Illya Gerasymchuk</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://iluxonchik.github.io/chave-movel-digital-phone-number-information-leakage/" rel="bookmark" title="Chave Móvel Digital Phone Number Leakage" itemprop="url">Chave Móvel Digital Phone Number Leakage</a></h1>
    
  </header>
  <div class="entry-content">
    <ul>
  <li><a href="/weak-security-of-portuguese-government/">Part 1 - The Weak Security Of The Portuguese Government’s Authentication System</a></li>
  <li><a href="/chave-movel-digital-xss">Part 2 - Chave Móvel Digital Multiple XSS Vulnerabilites</a></li>
  <li><strong>Part 3 - Chave Móvel Digital Phone Number Leakage</strong></li>
  <li><a href="/chave-movel-digital-does-not-log-out">Part 4 - Chave Móvel Digital Log Out Not Working</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>In this blog post I will be exploring the information leakage regarding
if a phone number is registered or not. The system has a protection
measure which can be easily bypassed. I will also provide proof-of-concept
code.</p>

<h1 id="determining-if-a-phone-number-is-registered-with-an-account">Determining If A Phone Number Is Registered With An Account</h1>

<p>If you enter a wrong phone number and PIN combination, you will be
presented with the following message:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> The System Ties To Hide Information</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/ambig_msg.png" alt="The System Ties To Hide Information" /></td></tr>
</table>

<p>The error message reads:</p>

<p><code class="highlighter-rouge">
O número de telemóvel ou o PIN estão errados ou registo inexistente
</code></p>

<p>Which translates to:</p>

<p><code class="highlighter-rouge">
Either the phone number or the PIN are incorrect or the account
is not registered.
</code></p>

<p>This might seem like a good thing: the system tries to give the
attacker the least information possible. The problem is that
this is useless, since it can be easily bypassed.</p>

<p>The issue is that if the phone number is registered, after <code class="highlighter-rouge">3</code> failed
attempts, your account will be temporary locked. If the phone number is not
registered, no lock in will occur.</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 2:</b> Error Message When The Number Is Registered</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/auth_err_msg.png" alt="Error Message When The Number Is Registered" /></td></tr>
</table>

<p>The good news is that if you enter the wrong <code class="highlighter-rouge">PIN</code> is entered again,
the temporary lockout period will be extended. Sometimes, you might be
asked to solve a captcha. My personal experience, however, suggests that
some simple machine learning can be used to bypass it. A better solution
here would be to use a more sophisticated solution, like Google’s <a href="https://www.google.com/recaptcha/intro/v3beta.html">ReCaptcha</a>.</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 3:</b> A Simple Captcha Is Used</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/simple_captcha.png" alt="A Simple Captcha Is Used" /></td></tr>
</table>

<p>Once you know that a phone number is registered in the system, you
could apply social engineering attacks to obtain access to the user’s account.
For example, in Portugal, you can send SMS messages with any Sender ID.
Services like <a href="https://aws.amazon.com/sns/pricing/">Amazon SNS</a> are cheap
and easy to use. When you receive your second-factor authentication code,
it comes from the sender <code class="highlighter-rouge">CMD</code> (it stands for <em>Chave Móvel Digital</em>, or
  Digital Mobile Key, in English). What an attacker could do is send the
user an SMS message with the sender id <code class="highlighter-rouge">CMD</code> saying that there is an issue
with the user’s account and that he needs to follow the provided link
to solve it. The link could perhaps exploit the <a href="https://iluxonchik.github.io/chave-movel-digital-xss/">XSS vulnerability described in the previous post</a>
to get the user’s PIN.</p>

<p>While not being a critical issue, it renders the existing protection system
useless. What they could instead do is treat all of the numbers the same:
lock the access to all of them, regardless of the fact if they are
registered or not. This should, however, be done with some care.
If you follow the naive approach of inserting every entered phone
number into the database and counting the number of login attempts,
the attacker might be able to flood the database with numbers. Careful
system design is needed here to prevent DoS attacks.</p>

<p>The same trick works with e-mail and Twitter authentication. These two
authentication methods are, however, not enabled by default.</p>

<h1 id="proof-of-concept">Proof-Of-Concept</h1>

<p>I wrote a simple <a href="https://github.com/iluxonchik/autenticacao-gov-pt-bruteforcer-pof">proof-of-concept code</a>.</p>

<p>A quick reverse-engineering of the authentication process showed that in order to access the login page, you need to go thought a specific sequence of steps, you can’t just go to the login page directly.</p>

<p>In that sequence of steps, your browser exchanges cookies with the server.
Among those, there are <code class="highlighter-rouge">3</code> different session ids that you get through this
process and a request that checks if your browser supports JavaScript.</p>

<p>With every <code class="highlighter-rouge">POST</code> request a <code class="highlighter-rouge">humanCheck</code> value is sent. This value is
set on document load:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#humanCheck'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">'8FBB298A-DE46-4657-88E8-95F1F1224784'</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">"#inputMobile"</span><span class="p">).</span><span class="nx">intlTelInput</span><span class="p">();</span>
        <span class="p">});</span></code></pre></figure>

<p>I initially thought that that was a unique
value generated on every request, acting as a nonce. Further analysis
showed that this value is fixed. I’ve tried
with different IP’s, different browsers and the value remained the
same.</p>

<h1 id="conclusion">Conclusion</h1>

<p>As demonstrated in this blog post, while the system tries to be ambiguous by not
exposing if the phone number is registered with an account or not, it can be
easily bypassed.</p>

<p>In the <a href="/chave-movel-digital-does-not-log-out">next and final blog post of this series</a> I will explore another issue: the fact
that the “Log Out” button does not actually log you out.</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2018-05-13T17:00:01+01:00"><a href="https://iluxonchik.github.io/chave-movel-digital-xss/">May 13, 2018</a></time></span><span class="author vcard"><span class="fn"><a href="https://iluxonchik.github.io/about/" title="About Illya Gerasymchuk">Illya Gerasymchuk</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://iluxonchik.github.io/chave-movel-digital-xss/" rel="bookmark" title="Chave Móvel Digital Multiple XSS Vulnerabilities" itemprop="url">Chave Móvel Digital Multiple XSS Vulnerabilities</a></h1>
    
  </header>
  <div class="entry-content">
    <ul>
  <li><a href="/weak-security-of-portuguese-government/">Part 1 - The Weak Security Of The Portuguese Government’s Authentication System</a></li>
  <li><strong>Part 2 - Chave Móvel Digital Multiple XSS Vulnerabilites</strong></li>
  <li><a href="/chave-movel-digital-phone-number-information-leakage">Part 3 - Chave Móvel Digital Phone Number Leakage</a></li>
  <li><a href="/chave-movel-digital-does-not-log-out">Part 4 - Chave Móvel Digital Log Out Not Working</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>In this blog post, I will be exploring the Reflected Cross-Site-Scripting (XSS) vulnerability present in the Portuguese government’s authentication
system’s website <a href="https://www.autenticacao.gov.pt/">www.autenticacao.gov.pt</a>.</p>

<p>The XSS vulnerability is present in the <em>Chave Móvel Digital</em> (CMD) login page.</p>

<h1 id="the-xss-vulnerability">The XSS Vulnerability</h1>

<p>At the moment of writing this post, there are 3 ways that you can authenticate
yourself:</p>

<ul>
  <li>the second-factor code is sent to your mobile phone number</li>
  <li>the second-factor code is sent to your e-mail</li>
  <li>the second-factor code is sent to your as a private Twitter message</li>
</ul>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> Chave Movel Digital Authentication Options</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/auth_opts.png" alt="Chave Movel Digital Authentication Options" /></td></tr>
</table>

<p>I’m going to choose the phone number authentication method, since
this is the only one that’s required. The other two are not activated by
default. The XSS vulnerability seems to only work on the
mobile phone number and Twitter authentication methods. E-mail authentication
seems to be doing input sanitization correctly. There are two separate places where you can login:
the “Personal Area”, which only allows mobile phone number login, and the
regular one, which allows the 3 authentication methods described above.
The XSS vulnerability works in both places.</p>

<p>This is how the main login page looks like:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 2:</b> Digital Mobile Key login page</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/login_page.png" alt="Digital Mobile Key login page" /></td></tr>
</table>

<p>To login to the portal, you need to enter your mobile phone number and a
numeric <code class="highlighter-rouge">PIN</code>. The <code class="highlighter-rouge">Mobile phone number</code> field is the one that will be used
to exploit the <code class="highlighter-rouge">XSS</code> vulnerability. Throughout this section I will be using
<code class="highlighter-rouge">1234</code> as the <code class="highlighter-rouge">PIN</code> number.</p>

<p>Now let’s see what happens when I try to enter a phone number that consists
only of letters (<code class="highlighter-rouge">Hello, World"</code>):</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 3:</b> Digital Mobile Key login page</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/enter_text.png" alt="Digital Mobile Key login page" /></td></tr>
</table>

<p>And now let’s click on “Authenticate”:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 4:</b> User input gets copied without validation</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/enter_text_authenticate.png" alt="User input gets copied without validation" /></td></tr>
</table>

<p>Even though the page says <code class="highlighter-rouge">The phone field only allows numbers</code>, at the bottom, it
still copies the input that I provided verbatim to the same field.
At this point I was pretty sure that the page is vulnerable to <code class="highlighter-rouge">XSS</code>.
So I looked at the source code to see how it can be exploited:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 5:</b> The input is copied to the value attribute</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/value_attr_input.png" alt="The input is copied to the value attribute" /></td></tr>
</table>

<p>Okay, so the input is you provided initially is copied to the <code class="highlighter-rouge">value</code>
attribute of the <code class="highlighter-rouge">inputMobile</code> element. So let’s try to show a very simple
<code class="highlighter-rouge">XSS</code> that would inject a new <code class="highlighter-rouge">span</code> element into the page and would comment
out some of the <code class="highlighter-rouge">HTML</code>. For this, in the <code class="highlighter-rouge">Mobile phone number</code> field, we’ll
input the following text: <code class="highlighter-rouge">" &lt;span&gt; Hello, World &lt;/span&gt; &lt;!--</code>.</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> A simple XSS input</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/xss_input.png" alt="A simple XSS input" /></td></tr>
</table>

<p>And here is the result:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 6:</b> Successful result of an XSS injection</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/xss_result.png" alt="Successful result of an XSS injection" /></td></tr>
</table>

<p>As you can see, our custom <code class="highlighter-rouge">HTML</code>was successfully injected into the page.
The rest of the page wasn’t commented out only because there is another
closing <code class="highlighter-rouge">HTML</code> comment tag (<code class="highlighter-rouge">--&gt;</code>) present in the page’s source.</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> Resulting HTML from the XSS attack</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/xss_source.png" alt="Resulting HTML from the XSS attack" /></td></tr>
</table>

<p>Below is a video demonstration of how this vulnerability can be exploited
to inject arbitrary JavaScript code into the page.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/jG8ZWBNqRyg?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen=""></iframe>

<p>Whenever the text in the “Mobile phone number” field is
changed, the <code class="highlighter-rouge">ShowPrint()</code> function is called. The only thing that it does is
copies the value from the <code class="highlighter-rouge">inputMobile</code> element to the <code class="highlighter-rouge">MainContent_hiddenMobile</code> attribute:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">ShowPrint</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">mobileValue</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"inputMobile"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"MainContent_hiddenMobile"</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">mobileValue</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span></code></pre></figure>

<p>Why this is done is not obvious, since both of the fields get <code class="highlighter-rouge">POST</code>ed to the
the backend when you click on “Authenticate”:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> Both of the attribute values get sent</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/form_data.png" alt="Both of the attribute values get sent" /></td></tr>
</table>

<p>However, if we manually change the value of the <code class="highlighter-rouge">MainContent_hiddenMobile</code>
field to <code class="highlighter-rouge">Hello, Reader</code> and leave <code class="highlighter-rouge">Hello, World</code> in the <code class="highlighter-rouge">inputMobile</code>
field, we can see that the value that that’s placed in the “Mobile phone number” box in the failed login page is the one from <code class="highlighter-rouge">MainContent_hiddenMobile</code>.</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 7:</b> Manually changing the value of the hidden input </caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/manual_change.png" alt="Manually changing the value of the hidden input " /></td></tr>
</table>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 8:</b> The hidden input value is the one that gets echoed back</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/manual_change_result.png" alt="The hidden input value is the one that gets echoed back" /></td></tr>
</table>

<h1 id="conclusion">Conclusion</h1>

<p>In this blog post I showed you the <code class="highlighter-rouge">POST</code> XSS vulnerability present
in the Portuguese government’s <code class="highlighter-rouge">autenticacao.gov.pt</code> <em>Chave Móvel Digital</em>
login page.</p>

<p>In the <a href="/chave-movel-digital-phone-number-information-leakage">next blog post</a> I will show you how you can find out if a
mobile phone number is registered with <em>Chave Móvel Digital</em> or not,
making the existing ambiguous “Either the mobile number or the PIN are
incorrect” message useless and opening the door for various social
engineering attacks.</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2018-05-13T17:00:00+01:00"><a href="https://iluxonchik.github.io/weak-security-of-portuguese-government/">May 13, 2018</a></time></span><span class="author vcard"><span class="fn"><a href="https://iluxonchik.github.io/about/" title="About Illya Gerasymchuk">Illya Gerasymchuk</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~9 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://iluxonchik.github.io/weak-security-of-portuguese-government/" rel="bookmark" title="The Weak Security Of The Portuguese Government's Authentication System" itemprop="url">The Weak Security Of The Portuguese Government's Authentication System</a></h1>
    
  </header>
  <div class="entry-content">
    <ul>
  <li><strong>Part 1 - The Weak Security Of The Portuguese Government’s Authentication System</strong></li>
  <li><a href="/chave-movel-digital-xss">Part 2 - Chave Móvel Digital Multiple XSS Vulnerabilites</a></li>
  <li><a href="/chave-movel-digital-phone-number-information-leakage">Part 3 - Chave Móvel Digital Phone Number Leakage</a></li>
  <li><a href="/chave-movel-digital-does-not-log-out">Part 4 - Chave Móvel Digital Log Out Not Working</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>Back in January 2018, after about half an hour of exploring
the “secure” authentication system provided by the Portuguese government
I found various security issues and vulnerabilities. I will briefly
explore them in a series of blog posts.</p>

<p>In this first blog post I will explain what is <code class="highlighter-rouge">autenticacao.gov.pt</code> and
<em>Chave Móvel Digital</em>, as well as the sensitive information that they
are supposed to be restricting the access too. I will also explore the
overall weak security that the system has.</p>

<p>This whole series of blog posts is a result of my findings in a short
period of time. It’s a compilation of the notes that I took, as a draft
to be submitted to responsible agency, as part of responsible disclosure.
A more thorough security audit is likely to reveal a lot
more problems. If about 30 minutes is all to took to find those problems,
what more would a malicious, motivated attacker would find.</p>

<p>I’m hoping that the issues will be fixed as soon as possible.</p>

<h1 id="responsible-disclosure">Responsible Disclosure</h1>

<p>On January 21st I emailed <code class="highlighter-rouge">ama@ama.pt</code> (email of the responsible agency),
describing the vulnerabilities and security issues, as well as offering
a more detailed description draft and Proof-Of-Concept code, but
obtained no answer.</p>

<h1 id="what-is-autenticacaogovpt-and-chave-movel-digital-cmd">What Is Autenticacao.gov.pt and Chave Movel Digital (CMD)?</h1>

<p><a href="https://autenticacao.gov.pt">Autenticacao.gov.pt’s homepage</a> has the
following text:</p>

<p><code class="highlighter-rouge">
O sítio oficial dos meios de identificação eletrónica,
assinatura digital e autenticação segura do Estado.
</code></p>

<p>which translates to:</p>

<p><code class="highlighter-rouge">
The official site of the means of electronic identification, digital signature
and state's secure authentication.
</code></p>

<p>Basically, it’s an authentication system that allows the Portuguese citizens
to authenticate to administrative public services. Once authenticated, you can, among other things:</p>

<ul>
  <li>register a birth of a child</li>
  <li>register a vehicle</li>
  <li>register a company</li>
  <li>request a birth certificate</li>
  <li>obtain the criminal record of an individual or a company</li>
  <li>submit/consult revenue of an individual or a company</li>
  <li>sign documents</li>
</ul>

<p>New functionalities are constantly added. As you can see, it is a very
useful system, since it allows you to save a lot of time. It allows you
to do many things from the comfort of your home and in minutes, instead
of spending hours at the pubic administrative services.</p>

<p>Despite being very useful, it does expose some sensitive personal
information and allows you to do some sensitive actions. If this
gets into the wrong hands, it can lead to many problems, such as
identity theft.</p>

<p>For this reason, it is very important to have a secure authentication system.
This is what <em>Chave Móvel Digital (CMD)</em>, which translates to Digital
Mobile Key, supposedly does. The main problem with it is that its security
is questionable.</p>

<h1 id="bad-security-from-the-ground-up">Bad Security From The Ground Up</h1>

<p>So now let’s briefly talk about the security of the <em>Chave Móvel Digital</em> authentication system.
In December of 2017 me and <a href="https://www.facebook.com/daria.ianklovich/">my girlfriend</a> went to a Christmas fair. Among other
things, there were various company booths. One of them was VR-related, so
we decided to go in and check it out. After playing around with the Microsoft’s
HoloLens for a little bit, we were approached by a lady there that asked us
if we have already activated the <em>Chave Móvel Digital</em> system. After
explaining to me what that was, she told me that it soon would be mandatory
to have it activated. I could either do it there now or go to the public
administrative organs, wait in queue for hours and do it there.</p>

<p>Motivated by the interest in the security of this new system and the potential
future time savings (bureaucracy is a big issue in Portugal), I decided
to activate it there.</p>

<h3 id="the-authentication-process">The Authentication Process</h3>

<p>Let’s look at the authentication process. To login using the <em>Chave Móvel Digital</em> system you have to enter your
mobile phone number and your PIN. If the entered details are correct, a
code is sent to your mobile number, which you have to enter to login.</p>

<p>The issues here are the following:</p>

<ul>
  <li>PIN can only be 4-8 numeric digits</li>
  <li>SMS as the only second factor authentication option</li>
</ul>

<p>The first one is the most serious one. PIN is essentially your password.
The issue here is that it only be <strong>numeric</strong> its length is <strong>limited</strong> to
be between 4 and 8 characters.</p>

<p>Let’s look at the numbers. <code class="highlighter-rouge">8</code> digit numeric-only passwords means that
there are <code class="highlighter-rouge">10^8 = 100000000</code> possible combinations. This is nothing for
modern computer. For example, let’s see how long will it take to generate
all of the possible combinations on my machine. Assuming that the file
<code class="highlighter-rouge">gen.py</code> contains the following code:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># gen.py file contents</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99999999</span><span class="p">):</span>
    <span class="k">pass</span></code></pre></figure>

<p>Here is what <code class="highlighter-rouge">time python gen.py</code> gives us:</p>

<p>$ time python gen.py
python gen.py  3.20s user 0.01s system 99% cpu 3.208 total</p>

<p>While this is not the most accurate way of measuring the process execution
time, it’s good enough to transmit the idea of how quick modern computers are
at generating the entire key space. This is to give you an intuition of
<strong>how small the number of possible PINs is</strong>. It’s <code class="highlighter-rouge">2018</code> and the Portuguese government
seems to think that 4 to 8 digit passwords are secure.</p>

<p>Let’s compare this to an <code class="highlighter-rouge">8</code> character long password that allows
numbers (10 different: <code class="highlighter-rouge">0-9</code>), letters (52 different: <code class="highlighter-rouge">a-z</code> and <code class="highlighter-rouge">A-Z</code>) and special characters (32 different). For every position we would have
<code class="highlighter-rouge">10 + 52 + 32 = 94</code> possible values. This means that there would be a total of
<code class="highlighter-rouge">94^8=6095689385000000</code> possible combinations. If we use the rule of three
to estimate how long it would take my computer to generate the entire key
space, we would see that it would come out to <strong>more than 6 years</strong>.</p>

<p>As an interesting note, when I was signing up with the system, the lady
told me that from her experience people usually choose <code class="highlighter-rouge">4</code> digit PINs, so
that they’re the same as their phone PINs. This seems like a reasonable
assumption to take. In this case, the simple task is made even simpler, since
the number of possible combinations is lowered to <code class="highlighter-rouge">10^4 = 10000</code>:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># gen.py file contents</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9999</span><span class="p">):</span>
    <span class="k">pass</span></code></pre></figure>

<p>Here is what <code class="highlighter-rouge">time python gen.py</code> gives us:</p>

<p>$ time python gen.py
python gen.py  0.01s user 0.01s system 98% cpu 0.015 total</p>

<p>I presented the time measurements just to give you an idea of <strong>how
small the possible key space is</strong>. Of course, we can’t conclude that the PIN
will be bruteforced in <code class="highlighter-rouge">3</code> seconds. The system limits the number of
attempts that you can perform. However, if you think that this makes bruteforcing
impossible, you’re wrong. I will now demonstrate why.</p>

<p>Let’s assume that the number of login attempts is limited to 3 (in reality,
<code class="highlighter-rouge">autenticacao.gov.pt</code> <strong>allows more than 3 attempts</strong>). Let’s also assume that a lot of people will in fact
use a <code class="highlighter-rouge">4</code> digit long PIN. This means that for each individual user there will
be a <code class="highlighter-rouge">3/10000</code> chance of guessing his PIN. Pretty unlikely, right?
Well, this number also means that <strong>for every 10000 accounts the attacker
will guess the PIN of 3 of them</strong>.</p>

<p>To make the things worse, the numbers above are assuming a totally random
distribution of PINs, which is not true. A <a href="https://www.popsci.com/technology/article/2012-09/infographic-day-fastest-way-crack-4-digit-pin-number">data analysis of almost 3.4 million four digit passwords</a> showed that <code class="highlighter-rouge">1234</code>, <code class="highlighter-rouge">0000</code> and <code class="highlighter-rouge">1111</code>
make up almost <code class="highlighter-rouge">20%</code> of used passwords. Considering this, the probability
of guessing the PIN of a single account would be about <code class="highlighter-rouge">2000/10000</code>.
Therefore, <strong>for every 10000 accounts the attacker would guess the PIN of 2000 of them</strong>.</p>

<p>Why doesn’t the system allow passwords that contain numbers, letters and special
characters? Maybe it comes down to a legacy issue, but it is definitely possible to write
middleware that would take care of that. The system is supposed to protect
very sensitive data, after all.</p>

<p>As an example, let me present to you a very simple solution that would make
the existing system more secure. It would do it so by allowing the users to use
a password that consists of numbers, letters and special characters, while
keeping the core legacy backend unchanged. I’m going to take the following
assumptions:</p>

<ul>
  <li>the backend requires a 4-8 digit <code class="highlighter-rouge">PIN</code></li>
  <li>all of the PINs are stored in plain text</li>
</ul>

<p>A very simple solution would be to do the following:</p>

<ol>
  <li>When the user is registering/changing his password: hash the password provided by the user with the phone number and store it in the database. Generate an 8 digit PIN and store it. This PIN will never be revealed to the user.</li>
  <li>When the users tries to log in: hash the provided password with the phone
number and compare this result to the one that you have stored in the
database.
    <ul>
      <li>if they are equal, send an “OK” to the backend, which will then
  obtain the PIN from the database and use it as needed</li>
      <li>if they are not equal, fail the authentication</li>
    </ul>
  </li>
</ol>

<p>I am in no way suggesting that this is the best solution, because it is not.
It is, however, a very simple one, that would require very little changes
to the overall system and keeping the core legacy backend unchanged.
All you would have to do is add a new table to the database (this way you
  will keep your existing tables unchanged) for the password hash and
change the authentication code in the middlware between the client and the
backend system. Even if the system is different from the one in my assumptions,
you can adopt the solution with relative ease.</p>

<p>The second point relates to only allowing SMS as the second-factor
authentication. While being a lot better than not using two-factor
authentication at all, it’s not the most secure option.
Let me give you two examples. By using some social engineering, if an attacker
can get access to your personal information, they can contact your phone
company and move your phone number to a new SIM. By exploiting the <a href="https://www.theguardian.com/technology/2016/apr/19/ss7-hack-explained-mobile-phone-vulnerability-snooping-texts-calls">vulnerabilities in the
SS7 protocol</a> the attacker can
read all of your text messages.</p>

<p>Allowing the use of other authentication options, such as Google Authenticator
would make the second-factor authentication a lot more secure. In general,
I have a feeling that the engineers assumed that there was no need for
strong passwords, since two-factor authentication is required and
only the user has the access to his mobile phone number. This assumption
is, of course, incorrect. While it is true, that if you’re using a <strong>good
second-factor authentication</strong>, it’s safe to weaken your password,
this does not apply to making your password a trivial 4-8 digit one.</p>

<p>Now, this just smelled <strong>bad security</strong>. I was certain that I could more problems. I was correct. The security issues that I’m going to be describing in this series of blog posts were found after about 30 minutes of
exploring.</p>

<p>There is now an option to receive your second-factor code
as a private message on Twitter or be sent to your e-mail address. Those
are not enabled by default and you have to do it yourself. I am not
sure when those options were added. In any case,
when logging in into your “Personal Area”, you only have the option of
using your mobile phone number.</p>

<h1 id="conclusion">Conclusion</h1>

<p>In this first post of the four-part series I described why the security
of the authentication system is flawed. This is also what motivated me
to explore further: I was sure that it wouldn’t be hard to find more issues,
since the “security” of this “secure authentication system” did seem
like an afterthought.</p>

<p>In the <a href="/chave-movel-digital-xss">next blog post</a>, I will be describing the multiple XSS vulnerabilities
present in the authentication page.</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-09-08T00:00:00+01:00"><a href="https://iluxonchik.github.io/regular-expression-check-if-number-is-prime/">September 08, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="https://iluxonchik.github.io/about/" title="About Illya Gerasymchuk">Illya Gerasymchuk</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~24 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://iluxonchik.github.io/regular-expression-check-if-number-is-prime/" rel="bookmark" title="Demystifying The Regular Expression That Checks If A Number Is Prime" itemprop="url">Demystifying The Regular Expression That Checks If A Number Is Prime</a></h1>
    
  </header>
  <div class="entry-content">
    <h1 id="introduction">Introduction</h1>

<p>A while back I was researching the most efficient way to check if a number is
prime. This lead me to find the following piece of code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="n">n</span><span class="o">]).</span><span class="na">matches</span><span class="o">(</span><span class="s">".?|(..+?)\\1+"</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>I was intrigued. While this might not be the most efficient way, it’s
certainly one of the less obvious ones, so my curiosity kicked in.
How on Earth could a match for the <code class="highlighter-rouge">.?|(..+?)\1+</code> regular expression tell that
a number is <strong>not</strong> prime (once it’s converted to its <a href="https://en.wikipedia.org/wiki/Unary_numeral_system">unary representation</a>)?</p>

<p>If you’re interested, read on, I’ll try to dissect this regular expression and
explain what’s really going on. The explanation will be programming language
agnostic, <a href="#4-code-examples">I will, however, provide</a> <code class="highlighter-rouge">Python</code>, <code class="highlighter-rouge">JavaScript</code> and <code class="highlighter-rouge">Perl</code> versions
of the <code class="highlighter-rouge">Java</code> code above and explain why they are slightly different.</p>

<p>I will explain how the regular expression <code class="highlighter-rouge">^.?$|^(..+?)\1+$</code> can filter out
any prime numbers. Why this one and not <code class="highlighter-rouge">.?|(..+?)\1+</code> (the one used in <code class="highlighter-rouge">Java</code> code example above)?
Well, this has to do with the way <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#matches-java.lang.String-">String.matches()</a> works, which <a href="#3-the-java-case">I’ll explain later</a>.</p>

<p>While there are some blog posts on this topic, I found them to not go deep enough
and give just a high level overview, not explaining some of the important details well enough.
Here, I’ll try to lay it out with enough detail so that anyone can follow and understand.
The goal is to make it simple to understand for any one - whether you are a regular expression
guru or this is the first time you’ve heard about them, anyone should be able to follow along.</p>

<h1 id="prime-numbers-and-regular-expressions---the-theory">1. Prime Numbers and Regular Expressions - The Theory</h1>

<p>Let’s start at a higher level. But wait, first, let’s get every one on the same
page and begin with some definitions. If you know know what a prime number is
and are familiar with regular expression, feel free to <a href="#the-regular-expression-that-tells-if-a-number-is-prime">skip this section</a>.
I will try to explain how every bit of the regular expression works, so that even
people who are new or unfamiliar with them can follow along.</p>

<h2 id="prime-numbers">Prime Numbers</h2>

<p>First, a <strong>prime number</strong> is any natural number greater than <code class="highlighter-rouge">1</code> <strong>that is only divisible by 1 and the number itself, without leaving a remainder</strong>.
Here’s a list of the fist <code class="highlighter-rouge">8</code> prime numbers: <code class="highlighter-rouge">2, 3, 5, 7, 11, 13, 17, 19</code>.
For example, <code class="highlighter-rouge">5</code> is prime because you can only divide it by <code class="highlighter-rouge">1 </code> and <code class="highlighter-rouge">5</code> 
without leaving a remainder. Sure we can divide it by <code class="highlighter-rouge">2</code>, but that
would leave a remainder of <code class="highlighter-rouge">1</code>, since <code class="highlighter-rouge">5</code> = <code class="highlighter-rouge">2</code>*<code class="highlighter-rouge">2</code> + <code class="highlighter-rouge">1</code>.
The number <code class="highlighter-rouge">4</code>, on the other hand, is <strong>not prime</strong>, since we can divide it
by <code class="highlighter-rouge">1</code>, <code class="highlighter-rouge">2</code> and <code class="highlighter-rouge">4</code> without leaving a remainder.</p>

<h2 id="regular-expressions">Regular Expressions</h2>

<p>Okay, now let’s get to the regular expression (A.K.A. regex) syntax. Now, there are quite a few regex
flavors, I’m not going to focus on any specific one, since that is not the
point of this post. The concepts described here
work in a similar manner in all of the most common flavors, so don’t worry
about it. If you want to learn more about regular expressions, check out
<a href="http://www.regular-expressions.info/">Regular-Expressions.info</a>, it’s a great
resource to learn regex and later use it as a reference.</p>

<p>Here’s a cheatsheet with the concepts that will be needed for the explanation
that follows:</p>

<ul>
  <li><code class="highlighter-rouge">^</code> - matches the position before the first character in the string</li>
  <li><code class="highlighter-rouge">$</code> - matches the position right after the last character in the string</li>
  <li><code class="highlighter-rouge">.</code> - matches any character, except line break characters (for example, it does not match <code class="highlighter-rouge">\n</code>)</li>
  <li><a name="alternation-operator"></a><code class="highlighter-rouge">|</code> - matches everything that’s either to the left or the right of it. You can think of it as an <strong>or</strong> operator.</li>
  <li><code class="highlighter-rouge">(</code> and <code class="highlighter-rouge">)</code> delimit a <strong>capturing group</strong>. By placing a part of a regular expression between parentheses, you’re grouping that part of the regular expression together. This allows you to apply <strong>quantifiers</strong> (like <code class="highlighter-rouge">+</code>)
to the entire group or restrict alternation (<em>i.e.</em> “or”: <code class="highlighter-rouge">|</code>) to part of the
regular expression. Besides that, parentheses also create a <strong>numbered capturing group</strong>, which you can refer to later with <strong>backreferences</strong> (<a href="capturing-groups-and-backreferences">more on that below</a>)</li>
  <li><a name="backref"></a><code class="highlighter-rouge">\&lt;number_here&gt;</code> - <strong>backreferences</strong> match the same text as previously matched by a capturing group. The <code class="highlighter-rouge">&lt;number_here&gt;</code> is the <strong>group number</strong> (remember the discussion above? The one that says that parentheses create a <strong>numbered capturing group</strong>? That’s where it comes in). I’ll give an example to clarify things in a little bit, so if you’re confused, hang on!</li>
  <li><code class="highlighter-rouge">+</code> - matches the preceding token (for example, it can be a character or a group of characters, if the preceding token is a <strong>capturing group</strong>) <strong>one or more times</strong></li>
  <li><code class="highlighter-rouge">*</code> - matches the preceding token <strong>zero or more times</strong></li>
  <li><a name="greedy-qmrk"></a>if <code class="highlighter-rouge">?</code> is used after <code class="highlighter-rouge">+</code> or <code class="highlighter-rouge">*</code> quantifiers, it makes that quantifier <strong>non-greedy</strong> (<a href="#greedy-and-non-greedy-quantifiers">more on that below</a>)</li>
</ul>

<h3 id="capturing-groups-and-backreferences">Capturing Groups and Backreferences</h3>

<p>As promised, let’s clarify how <strong>capturing groups</strong> and <strong>backreferences</strong> work together.</p>

<p>As I mentioned, parentheses create <strong>numbered capturing groups</strong>. What do I
mean by that? Well, that means that when you use parentheses, you create a
group that matches some characters and you can refer to those <strong>matched characters</strong> later on. The numbers are given to the groups in the order they
appear in the regular expression, beginning with <code class="highlighter-rouge">1</code>. For example, let’s say
you have the following regular expression: <code class="highlighter-rouge">^aa(bb)cc(dd)$</code>. Note, that in this
case, we have <code class="highlighter-rouge">2</code> groups. They are numbered as follows:</p>

<p><img src="http://i.imgur.com/7T2JC1A.png" alt="Regular Expression capturing group numbers" /></p>

<p>This means that we can refer to the characters matched by them later using
<strong>backreferences</strong>. If we want to refer to what is matched by <code class="highlighter-rouge">(bb)</code>, we use
<code class="highlighter-rouge">\1</code> (we use <code class="highlighter-rouge">1</code> because we’re referring to the <strong>capturing group #1</strong>). To refer to the characters matched by <code class="highlighter-rouge">(dd)</code> we use <code class="highlighter-rouge">\2</code>. Putting that together,
the the regular expression <code class="highlighter-rouge">^aa(bb)cc(dd)\1$</code> matches the string <code class="highlighter-rouge">aabbccddbb</code>.
Note how we used <code class="highlighter-rouge">\1</code> to refer to the last <code class="highlighter-rouge">bb</code>. <code class="highlighter-rouge">\1</code> refers to <strong>what was matched</strong> by the group <code class="highlighter-rouge">(bb)</code>, which in this case, was the sting <code class="highlighter-rouge">bb</code>.</p>

<p>Now note that I emphasize on <strong>what was matched</strong>. I really mean the 
characters that <strong>were matched</strong> and not ones that <strong>can be matched</strong>.
This means, that the regular expression <code class="highlighter-rouge">^aa(.+)cc(dd)\1$</code>
<strong>does match</strong> the sting <code class="highlighter-rouge">aaHELLOccddHELLO</code>, but <strong>does not</strong> match the sting
<code class="highlighter-rouge">aaHELLOccddGOODBYE</code>, since it cannot find what was matched by the <strong>group #1</strong> (in this case it’s the character sequence <code class="highlighter-rouge">HELLO</code>) after the character sequence <code class="highlighter-rouge">dd</code> (it finds <code class="highlighter-rouge">GOODBYE</code> there).</p>

<h3 id="greedy-and-non-greedy-quantifiers">Greedy and Non-Greedy Quantifiers</h3>

<p>If you remember correctly, in the cheatseheet above, I mentioned that <code class="highlighter-rouge">?</code>
<a href="#greedy-qmrk">can be used to make the preceding quantifier non-greedy</a>.
Well, okay, but what does that actually mean? <code class="highlighter-rouge">+</code> is greedy quantifier, this
means that <strong>it will try to repeat the preceding token as many times as possible</strong>, <em>i.e.</em> it will try to consume as much input as it can. The same
is true for the <code class="highlighter-rouge">*</code> quantifier.</p>

<p>For example, let’s say we have the string <code class="highlighter-rouge">&lt;p&gt;The Documentary&lt;/p&gt; (2005)</code> and
the regular expression <code class="highlighter-rouge">&lt;.+&gt;</code>. Now, you might think that it will match
<code class="highlighter-rouge">&lt;p&gt;</code>, but that’s not true. The matched string will actually be <code class="highlighter-rouge">&lt;p&gt;The Documentary&lt;/p&gt;</code>. Why is that? Well, that has to do with the fact mentioned
above: the <code class="highlighter-rouge">+</code> <strong>will try to consume as much input as it can</strong>, so that means
that it will not stop at the first <code class="highlighter-rouge">&gt;</code>, but rather at the last one.</p>

<p>Now how do we go about making a quantifier <strong>non-greedy</strong>? Well, you might
be already tired of hearing that (since I’ve already mentioned it twice),
but <strong>in order to make a greedy quantifier non-greedy, you put a question mark (?) in front of it</strong>. 
It’s really as simple as that. In case you’re still confused, don’t worry,
let’s see an example.</p>

<p>Suppose we have the same string: <code class="highlighter-rouge">&lt;p&gt;The Documentary&lt;/p&gt; (2005)</code>, but this
time, we only want to match what is between the first <code class="highlighter-rouge">&lt;</code> and <code class="highlighter-rouge">&gt;</code>.
How would we go about that? Well, all we have to do is add <code class="highlighter-rouge">?</code> in front of
the <code class="highlighter-rouge">+</code>. This will lead us to the <code class="highlighter-rouge">&lt;.+?&gt;</code> regex. “Uhhh, okay…”, you might wonder,
“But what does that actually do?”. Well, it will make the <code class="highlighter-rouge">+</code> quantifier
<strong>non-greedy</strong>. This means that it <strong>will make the quantifier consume as little input as possible</strong>.
Well, in our case, the “as little as possible” is <code class="highlighter-rouge">&lt;p&gt;</code>, which is
exactly what we want! To be precise, it will match both of the <code class="highlighter-rouge">p</code>’s: <code class="highlighter-rouge">&lt;p&gt;</code> and
<code class="highlighter-rouge">&lt;/p&gt;</code>, but we can easily get what we want by asking for the fist match (<code class="highlighter-rouge">&lt;p&gt;</code>).</p>

<h3 id="a-little-note-on--and-">A Little Note On ^ and $</h3>

<p>Since we’re on it, I’ll take a moment to quickly explain what the <code class="highlighter-rouge">^</code> and
<code class="highlighter-rouge">$</code> actually do. If you remember correctly, <code class="highlighter-rouge">^</code> matches the position right
before the first character in the string and <code class="highlighter-rouge">$</code> matches the position right after the last character in the string. Note how in both of the regular
expressions above (<code class="highlighter-rouge">&lt;.+&gt;</code> and <code class="highlighter-rouge">&lt;.+?&gt;</code>) we did not use them. What does that
mean? Well, that means that <strong>the match does not have to begin at the start of the string and end at the end of the string</strong>.
Taking the second, non-greedy, regex (<code class="highlighter-rouge">&lt;.+?&gt;</code>) and the sting <code class="highlighter-rouge">The Game - &lt;p&gt;The Documentary&lt;/p&gt; (2005)</code>, we would still obtain our expected matches (<code class="highlighter-rouge">&lt;p&gt;</code> and <code class="highlighter-rouge">&lt;/p&gt;</code>),
since we’re not forcing it to begin at the beginning of the string and end
at the end of the string.</p>

<h1 id="the-regular-expression-that-tells-if-a-number-is-prime">2. The Regular Expression That Tells If A Number Is Prime</h1>

<p>Phew, so we’re finally done with the theoretical introduction and now, since we’ve
already have everything we need under the belt, we’re ready to dive into
the analysis of how the <code class="highlighter-rouge">^.?$|^(..+?)\1+$</code> regular expression can match
<strong>non-prime</strong> numbers (in their unary form).</p>

<p>You can ignore the <code class="highlighter-rouge">?</code> in the regular expression, it’s there for performance reasons (<a href="#what-about-the">explained below</a>) - 
it makes the <code class="highlighter-rouge">+</code> non-greedy. If it confuses you, just ignore it and consider 
that the regex is actually <code class="highlighter-rouge">^.?$|^(..+)\1+$</code>, it works as well, but it’s slower (with some exceptions, like when the number <strong>is</strong> prime, where the <code class="highlighter-rouge">?</code> makes no difference whatsoever).
After explaining how this regular expression works, I’ll also <a href="#what-about-the">explain</a> what that <code class="highlighter-rouge">?</code> does there,
you shouldn’t have any trouble understanding it after you understand the inner workings of this
regex.</p>

<p><a name="unary-representation"></a>All of the discussion below assumes that we have the number represented in
its <a href="https://en.wikipedia.org/wiki/Unary_numeral_system">unary form</a> (or base-1, if you prefer). It doesn’t actually have to be represented as
a sequence of <code class="highlighter-rouge">1</code>s, it can be a sequence of any characters that are
matched by <code class="highlighter-rouge">.</code>. This means that <code class="highlighter-rouge">5</code> does not have to be represented as
<code class="highlighter-rouge">11111</code>, it might as well be represented as <code class="highlighter-rouge">fffff</code> or <code class="highlighter-rouge">BBBBB</code>. As long
as there are <strong>five characters</strong>, we’re good to go. Please note, that the
characters have to be the same, <strong>no mixtures of characters are allowed</strong>,
this means that we <strong>cannot</strong> represent <code class="highlighter-rouge">5</code> as <code class="highlighter-rouge">ffffB</code>, since here we have a mixture
of two different characters.</p>

<h2 id="high-level-overview">High Level Overview</h2>

<p>Let’s begin with a high level overview and then dive into the details.
Our <code class="highlighter-rouge">^.?$|^(..+?)\1+$</code> regular expression consists of two parts: <code class="highlighter-rouge">^.?$</code> and
<code class="highlighter-rouge">^(..+?)\1+$</code>.</p>

<p>As a heads-up, I just want to say that I’m lying a little in the explanation
in the <a href="#hlw-regex-2">paragraph</a> about the <code class="highlighter-rouge">^(..+?)\1+$</code> regex. The lie has to do with the order in which the regex engine
checks for multiples, it actually starts with the highest number and goes to the lowest,
and not how I explain it here. But feel free to ignore that distinction here, 
since the regular expression still matches the same thing, it just does it in more
steps (so I’ll actually be explaining how <code class="highlighter-rouge">^.?$|^(..+?)\1+?$</code> works: notice the extra <code class="highlighter-rouge">?</code> after the <code class="highlighter-rouge">+</code>.</p>

<p>I’m doing this because I believe this explanation is less verbose and easier to understand.
And don’t worry, I explain how I lied and <a href="#the-shocking-truth">reveal the shocking truth</a>
later on, so keep on reading. Well, maybe it’s not really that shocking, but 
I wanna keep you engaged, so I’ll stick to that naming.</p>

<p>The regex engine will first try to match <code class="highlighter-rouge">^.?$</code>, then, if it fails, it will try to
match <code class="highlighter-rouge">^(..+?)\1+$</code>. Note that <strong>the number of characters matched corresponds to the matched number</strong>,
<em>i.e.</em> if 3 characters are matched, that means that number <code class="highlighter-rouge">3</code> was matched, if 
26 characters are matched, that means that the number <code class="highlighter-rouge">26</code> was matched.</p>

<p><code class="highlighter-rouge">^.?$</code> matches strings with zero or one characters (corresponds to the numbers
<code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">1</code>, respectively).</p>

<p><a name="hlw-regex-2"> </a><code class="highlighter-rouge">^(..+?)\1+$</code> first tries to match 2 characters (corresponds to the number 2),
then 4 characters (corresponds to the number 4), then 6 characters, then 8
characters and so on. Basically it will try to match <strong>multiples of 2</strong>.
If that fails, it will try to first match 3 characters (corresponds to the number 3),
then 6 characters (corresponds to the number 6), then 9 characters, then 12 characters
and so on. This means that it will try to match <strong>multiples of 3</strong>. If that fails,
it proceeds to try match <strong>multiples of 4</strong>, then if that fails it will try
to match <strong>multiples of 5</strong> and so on, until the number whose multiple it tries to match is
the length of the string (<strong>failure</strong> case) or there is a successful match (<strong>success</strong> case).</p>

<h2 id="diving-deeper">Diving Deeper</h2>

<p>Note, that both of parts of the regular expression begin with a <code class="highlighter-rouge">^</code> symbol and end with a <code class="highlighter-rouge">$</code> symbol, this 
forces to what’s in between those symbols (<code class="highlighter-rouge">.?</code> in the first case and <code class="highlighter-rouge">(..+)\1+</code> in the second case) 
<strong>to start at the beginning of the string and end at the end of the string</strong>. 
In our case that string is the <a href="#unary-representation">unary representation of the number</a>. 
Both of the parts are separated separated by an <a href="#alternation-operator">alternation operator</a>,
this means that <strong>either only one of them will be matched or neither will</strong>.
If the number is prime, a match <strong>will not</strong> occur. If the number is not prime a
match <strong>will</strong> occur. To summarize, we concluded that:</p>

<ul>
  <li>either <code class="highlighter-rouge">^.?$</code> or <code class="highlighter-rouge">^(..+?)\1+$</code> will be matched</li>
  <li>the match has to be on the whole string, <em>i.e.</em> <strong>start at the beginning of the string and end at the end of the string</strong></li>
</ul>

<p>Okay, but what does each one those parts matches? Keep in mind that <strong>if a match occurs, it means that the number is not prime</strong>.</p>

<h3 id="how-the--regular-expression-works">How The ^.?$ Regular Expression Works</h3>

<p><code class="highlighter-rouge">^.?$</code> will match 0 or 1 characters. This match will be successful if:</p>

<ul>
  <li>the string contains <strong>only 1 character</strong> - this means that we’re dealing with
number <code class="highlighter-rouge">1</code> and, by definition, <code class="highlighter-rouge">1</code> <strong>is not prime</strong>.</li>
  <li>the string contains <strong>0 characters</strong> - this means that we’re dealing with
number <code class="highlighter-rouge">0</code>, and <code class="highlighter-rouge">0</code> is certainly <strong>not prime</strong>, since we can divide <code class="highlighter-rouge">0</code> by anything
we want, except for <code class="highlighter-rouge">0</code> itself, of course.</li>
</ul>

<p>If we’re given the sting <code class="highlighter-rouge">1</code>, <code class="highlighter-rouge">^.?$</code> will match it, since we have only one 
character in our string (<code class="highlighter-rouge">1</code>). The match will also occur if we provide an empty 
string, since, as explained before, <code class="highlighter-rouge">^.?$</code> will match either an empty string (0
characters) or a string with only 1 character.</p>

<p>Okay, so far so so good, we certainly want our regex to recognize <code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">1</code> as
non-primes. But that’s not enough, since there are numbers other than
<code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">1</code> that are not prime. This is where the second part of the regular
expression comes in.</p>

<h3 id="how-the-1-regular-expression-works">How The ^(..+?)\1+$ Regular Expression Works</h3>

<p><code class="highlighter-rouge">^(..+?)\1+$</code> will first try to match multiples of 2, then multiples of 3, then
multiples of 4, then multiples 5, then multiples of 6 and so on, until the multiple
of the number it tries to match is the length of the string or there is a successful match.</p>

<p>But how does it actually work? Well, let’s dissect it!</p>

<p>Let’s focus on the parentheses now, here we have <code class="highlighter-rouge">(..+?)</code> (remember, <code class="highlighter-rouge">?</code> just 
makes this expression <a href="greedy-and-non-greedy-quantifiers">non-greedy</a>). Notice
that we have a <code class="highlighter-rouge">+</code> here, which means “one or more of the preceding token”.
This regex will first try to match <code class="highlighter-rouge">(..)</code> (2 characters), then <code class="highlighter-rouge">(...)</code> (3 characters), 
then <code class="highlighter-rouge">(....)</code>  (4 characters), and so on, until the length of the string we’re 
matching against is reached or there is a successful match.</p>

<p>After matching for some number of characters (let’s call that number <code class="highlighter-rouge">x</code>, the regular expression will try to
see if the string’s length is multiple of <code class="highlighter-rouge">x</code>. How does it do that? Well, there’s
a <a href="backref">backreference</a>. This takes us to the second
part of the regex: <code class="highlighter-rouge">\1+</code>. Now, <a href="capturing-groups-and-backreferences">as explained before</a>
this will try to repeat the match in <strong>capturing group #1</strong> one or more times (<a href="#the-shocking-lie">actually it’s more “more or one times, I’m lying a little bit”</a>)
This means that first, it will try to match <code class="highlighter-rouge">x * 2</code> characters in the string, 
then <code class="highlighter-rouge">x * 3</code>, then <code class="highlighter-rouge">x * 4</code>, and so on. If it succeeds in any of those matches,
it returns it (and this means that the number <strong>is not</strong> prime). If it fails (it will fail when <code class="highlighter-rouge">x * &lt;number&gt;</code> exceeds the length of the string we’re matching against),
it will try the same thing, but with <code class="highlighter-rouge">x+1</code> characters, <em>i.e</em>, first <code class="highlighter-rouge">(x+1) * 2</code>, 
then <code class="highlighter-rouge">(x+1) * 3</code>, then <code class="highlighter-rouge">(x+1) * 4</code> and so on (because now the <code class="highlighter-rouge">\1+</code> backreference
refers to <code class="highlighter-rouge">x+1</code> characters). If the number of characters matched by <code class="highlighter-rouge">(..+?)</code> reaches
the <strong>length of the string we’re matching against</strong>, the regex matching process will stop and return a failure. If there is a successful match, it will be returned.</p>

<h3 id="example-time">Example Time</h3>

<p>Now, I’ll sketch some examples to make sure you got everything. I will provide
one example where a regular expression <strong>succeeds</strong> to match and one where it
<strong>fails</strong> to match. Again, <a href="#the-shocking-lie">I’m lying</a> in the order of sub-steps (the nested ones, <em>i.e</em> the ones that have a <code class="highlighter-rouge">.</code>, like <code class="highlighter-rouge">2.1</code>, <code class="highlighter-rouge">3.2</code>, etc), just a little.</p>

<p>As an example of <strong>where a match succeeds</strong>, let’s consider the string <code class="highlighter-rouge">111111</code>. The length of the string we’re matching against is <code class="highlighter-rouge">6</code>. 
Now, 6 is <strong>not</strong> a prime number, so we expect the regex to succeed with the match. Let’s see
a sketch of how it will work:</p>

<p><strong>1.</strong> It will try to match <code class="highlighter-rouge">^.?$</code>. No luck. The left side of <code class="highlighter-rouge">|</code> returns a <strong>failure</strong>
<strong>2.</strong> It try to match <code class="highlighter-rouge">^(..+?)\1+$</code> (the right side of <code class="highlighter-rouge">|</code>). It begins with <code class="highlighter-rouge">(..+?)</code> matching <code class="highlighter-rouge">11</code>:</p>

<ul>
  <li><strong>2.1</strong> The backreference <code class="highlighter-rouge">\1+</code> will try to match <code class="highlighter-rouge">11</code> twice (<em>i.e</em> <code class="highlighter-rouge">1111</code>). No luck.</li>
  <li><strong>2.2</strong> The backreference <code class="highlighter-rouge">\1+</code> will try to match <code class="highlighter-rouge">11</code> trice (<em>i.e</em> <code class="highlighter-rouge">111111</code>). <strong>Success!</strong>. Right side of <code class="highlighter-rouge">|</code> returns <strong>success</strong></li>
</ul>

<p>Woah, that was fast! Since the right side of <code class="highlighter-rouge">|</code> <strong>succeeded</strong>,
our regular expression <strong>succeeds</strong> with the match, which means our number is <strong>not</strong> prime.</p>

<p>As an example of <strong>where a match fails</strong>, let’s consider the string <code class="highlighter-rouge">11111</code>. The length of the string we’re matching against is <code class="highlighter-rouge">5</code>. 
Now, 5 is a prime number, so we expect the regex to fail to match anything. Let’s see
a sketch of how it will work:</p>

<p><strong>1.</strong> It will try to match <code class="highlighter-rouge">^.?$</code>. No luck. The left side of <code class="highlighter-rouge">|</code> returns a <strong>failure</strong>
<strong>2.</strong> It try to match <code class="highlighter-rouge">^(..+?)\1+$</code> (the right side of <code class="highlighter-rouge">|</code>). It begins with <code class="highlighter-rouge">(..+?)</code> matching <code class="highlighter-rouge">11</code>:</p>

<ul>
  <li><strong>2.1</strong> The backreference <code class="highlighter-rouge">\1+</code> will try to match <code class="highlighter-rouge">11</code> twice (<em>i.e</em> <code class="highlighter-rouge">1111</code>). No luck.</li>
  <li><strong>2.2</strong> The backreference <code class="highlighter-rouge">\1+</code> will try to match <code class="highlighter-rouge">11</code> trice (<em>i.e</em> <code class="highlighter-rouge">111111</code>). No luck. <strong>Length of string exceeded</strong> (6 &gt; 5). Backreference returns a <strong>failure</strong>.</li>
</ul>

<p><strong>3.</strong> <code class="highlighter-rouge">(..+?)</code> now matches <code class="highlighter-rouge">111</code>:</p>

<ul>
  <li><strong>3.1</strong> The backreference <code class="highlighter-rouge">\1+</code> will try to match <code class="highlighter-rouge">111</code> twice (<em>i.e</em> <code class="highlighter-rouge">111111</code>). No luck. <strong>Length of string exceeded</strong> (6 &gt; 5). Backreference returns a <strong>failure</strong>.</li>
</ul>

<p><strong>4.</strong> <code class="highlighter-rouge">(..+?)</code> now matches <code class="highlighter-rouge">1111</code>:</p>

<ul>
  <li><strong>4.1</strong> The backreference <code class="highlighter-rouge">\1+</code> will try to match <code class="highlighter-rouge">1111</code> twice (<em>i.e</em> <code class="highlighter-rouge">11111111</code>). No luck. <strong>Length of string exceeded</strong> (8 &gt; 5). Backreference returns a <strong>failure</strong>.</li>
</ul>

<p><strong>5.</strong> <code class="highlighter-rouge">(..+?)</code> now matches <code class="highlighter-rouge">11111</code>:</p>

<ul>
  <li><strong>5.1</strong> The backreference <code class="highlighter-rouge">\1+</code> will try to match <code class="highlighter-rouge">11111</code> twice (<em>i.e</em> <code class="highlighter-rouge">1111111111</code>). No luck. <strong>Length of string exceeded</strong> (10 &gt; 5). Backreference returns a <strong>failure</strong>.</li>
</ul>

<p><strong>5.</strong> <code class="highlighter-rouge">(..+?)</code> will try to match <code class="highlighter-rouge">1111111</code>. No luck. <strong>Length of string exceeded</strong> (6 &gt; 5). <code class="highlighter-rouge">(..+?)</code> returns a <strong>failure</strong>. The right side of <code class="highlighter-rouge">|</code> returns a <strong>failure</strong></p>

<p>Now since both sides of <code class="highlighter-rouge">|</code> failed to match anything, the regular expression <strong>fails</strong>
to match anything, which means our number is prime.</p>

<h3 id="what-about-the-">What About The ?</h3>

<p>Well, I mentioned that you can ignore the <code class="highlighter-rouge">?</code> symbol in the regular expression,
since <strong>it’s there only for performance reasons</strong>, and that’s true, but there is no
need to keep its purpose a mystery, so I’ll explain what it actually does there.</p>

<p>As mentioned before, <code class="highlighter-rouge">?</code> makes the preceding <code class="highlighter-rouge">+</code> <a href="#greedy-and-non-greedy-quantifiers">non-greedy</a>. What does it mean in practice? 
Let’s say our string is <code class="highlighter-rouge">111111111111111</code> (corresponds to the number 15). Let’s call
<code class="highlighter-rouge">L</code> the length of the string. In our case, <code class="highlighter-rouge">L=15</code>.</p>

<p>With the <code class="highlighter-rouge">?</code> present there, <code class="highlighter-rouge">+</code> will try to match its preceding token (in this case <code class="highlighter-rouge">.</code>) <strong>as few times as possible</strong>. This means that first <code class="highlighter-rouge">(..+?)</code> will
try to match <code class="highlighter-rouge">..</code>, then <code class="highlighter-rouge">...</code>, then <code class="highlighter-rouge">....</code> and then <code class="highlighter-rouge">.....</code>,
after which our whole regex (<code class="highlighter-rouge">^.?$|^(..+?)\1+$</code>) would <strong>succeed</strong>. So first, we’ll be testing the divisibility
by 2, then by 3, then by 4 and then by 5, after which we would have a match.
Notice that the number of steps in <code class="highlighter-rouge">(..+?)</code> was <strong>4</strong> (first it matches 2, then 3, then 4 and then 5).</p>

<p>If we omitted the <code class="highlighter-rouge">?</code>, <em>i.e</em> if we had <code class="highlighter-rouge">(..+)</code>, then it would go the other way around: first it would try to
match <code class="highlighter-rouge">...............</code> (the number 15, which is our <code class="highlighter-rouge">L</code>), then <code class="highlighter-rouge">..............</code> (the number 14, <em>i.e</em> <code class="highlighter-rouge">L-1</code>),
and so on until <code class="highlighter-rouge">.....</code>, after which the whole regex would <strong>succeed</strong>. Notice
that even though the result was the same as in <code class="highlighter-rouge">(..+?)</code>, in <code class="highlighter-rouge">(..+)</code> the number of steps was <strong>11</strong>
instead of <strong>4</strong>. By definition, <strong>any divisor of L must be no greater than L/2</strong>, so that means that
means that <strong>8</strong> steps were <strong>absolutely wasted computation</strong>, since first we tested
the divisibility by 15, then 14, then 13, and so on until 5 (we could only
hope for a match from number <strong>7</strong> and downwards, since <code class="highlighter-rouge">L/2 = 15/2 = 7.5</code>
and the first integer smaller than <code class="highlighter-rouge">7.5</code> is <code class="highlighter-rouge">7</code>).</p>

<h2 id="the-shocking-lie">The Shocking Lie</h2>

<p>As I mentioned before, I actually lied in the explanation of how the multiples of a number
are matched. Let’s say we have the string <code class="highlighter-rouge">111111111111111</code> (number 15).</p>

<p>The way I explained it before was that the regular expression would begin
to test for divisibility by <code class="highlighter-rouge">2</code>. It would do so by first trying to match
<code class="highlighter-rouge">2*2</code> characters, then <code class="highlighter-rouge">2*3</code>, then <code class="highlighter-rouge">2*4</code>, then <code class="highlighter-rouge">2*5</code>, then <code class="highlighter-rouge">2*6</code>, then <code class="highlighter-rouge">2*7</code>,
after which it would fail to match <code class="highlighter-rouge">2*8</code>, so it would try its luck with testing
for divisibility by <code class="highlighter-rouge">3</code>, by first trying to match for <code class="highlighter-rouge">3*2</code> characters, then for
<code class="highlighter-rouge">3*3</code> characters, then for <code class="highlighter-rouge">3*4</code> and then for <code class="highlighter-rouge">3*5</code>, where it would succeed.
This is actually what would happen if the regular expression was <code class="highlighter-rouge">^.?$|^(..+?)\1+?$</code>
(notice the <code class="highlighter-rouge">?</code> at the end), <em>i.e.</em>, if the <code class="highlighter-rouge">+</code>following the backreference was
<a href="#greedy-and-non-greedy-quantifiers">non-greedy</a>.</p>

<p>What actually happens is the opposite. It would still try to test
for the divisibility by <code class="highlighter-rouge">2</code>, first, but instead of trying to match for <code class="highlighter-rouge">2*2</code> characters,
it would begin with trying to match for <code class="highlighter-rouge">2*7</code>, then for <code class="highlighter-rouge">2*6</code>, then for <code class="highlighter-rouge">2*5</code>,
then for <code class="highlighter-rouge">2*4</code>, then for <code class="highlighter-rouge">2*3</code> and then for <code class="highlighter-rouge">2*2</code>, after which it would fail and, once again,
try its luck with divisibility by <code class="highlighter-rouge">3</code>, by first trying to match for <code class="highlighter-rouge">3*5</code> characters,
where it would succeed right away.</p>

<p>Notice, that in the second case, which is what happens in reality,
<strong>less steps are required</strong>: <strong>11</strong> in the first case vs <strong>7</strong> in the second (in reality, <strong>both of the cases would require more steps than presented here</strong>,
the goal of this explanation is not count them all, but to transmit the idea of what’s happening in both cases, it’s just a sketch of what’s going on under the hood).
While both versions are <strong>equivalent</strong>, the one explained in this blog post, is more efficient.</p>

<h1 id="the-java-case">3. The Java Case</h1>

<p>Here’s the piece of Java code that started all of this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="n">n</span><span class="o">]).</span><span class="na">matches</span><span class="o">(</span><span class="s">".?|(..+?)\\1+"</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>If you remember correctly, I said that due to the peculiarities of the way
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#matches-java.lang.String-">String.matches</a> works in Java, the regular expression that matches
non-prime numbers is not the one in the code example above (<code class="highlighter-rouge">.?|(..+?)\1+</code>),
but it’s actually <code class="highlighter-rouge">^.?$|^(..+?)\1+$</code>. Why? Well, turns out <code class="highlighter-rouge">String.matches()</code>
<strong>matches on the whole string</strong>, not on any substring of the string.
Basically, it “automatically inserts” all of the <code class="highlighter-rouge">^</code> and <code class="highlighter-rouge">$</code> present in the regex 
I explained in this post.</p>

<p>If you’re looking for a way not to force the match on the whole string in Java, you can use
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html">Pattern</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Matcher.html">Matcher</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Matcher.html#find--">Matcher.find()</a> method.</p>

<p>Other than that, it’s pretty much self explanatory: if the match succeeds, then
the number is <strong>not</strong> prime. In case of a successful match, <code class="highlighter-rouge">String.matches()</code>
returns <code class="highlighter-rouge">true</code> (number is <strong>not</strong> prime), otherwise, it return <code class="highlighter-rouge">false</code> (number is prime),
so to obtain the desired functionality we negate what the method returns.</p>

<p><code class="highlighter-rouge">new String(new char[n])</code> returns a <code class="highlighter-rouge">String</code>of <code class="highlighter-rouge">n</code> null characters (the <code class="highlighter-rouge">.</code> in our regex matches them).</p>

<h1 id="code-examples">4. Code Examples</h1>

<p>Now, as promised, it’s time for some code examples!</p>

<h2 id="java">Java</h2>

<p>Although I already presented this code example twice in this post,
I’ll do it here again, just to keep it organized.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="n">n</span><span class="o">]).</span><span class="na">matches</span><span class="o">(</span><span class="s">".?|(..+?)\\1+"</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h2 id="python">Python</h2>

<p>I’ve <a href="https://iluxonchik.github.io/why-you-should-learn-python/">expressed my sympathy for Python before</a>, so of course I have to include
this one here.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r'^.?$|^(..+?)</span><span class="err">\</span><span class="s">1+$'</span><span class="p">,</span> <span class="s">'1'</span><span class="o">*</span><span class="n">n</span><span class="p">)</span></code></pre></figure>

<h2 id="javascript">JavaScript</h2>

<blockquote>
  <p>Java is to JavaScript as car is to carpet.</p>
</blockquote>

<p>That’s a joke I like. I didn’t come up with it and I don’t really know its
first source, so I don’t know whom to credit. Anyways, I’m actually going to
give you two versions here, one which works in <a href="https://github.com/lukehoban/es6features">ES6</a>
and one that works in previous versions.</p>

<p>First, the ECMAScript 6 version:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">isPrime</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/^.</span><span class="se">?</span><span class="sr">$|^</span><span class="se">(</span><span class="sr">..+</span><span class="se">?)\1</span><span class="sr">+$/</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">!</span><span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'1'</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">n</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<p>The feature that’s only available in ECMAScript 6 is the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/repeat">String.prototype.repeat()</a>
method.</p>

<p>If you gotta use previous versions of ES, you can always fall back to
<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Array/join">Array.prototype.join()</a>.
Note, however, that we’re passing <code class="highlighter-rouge">n+1</code> to <code class="highlighter-rouge">join()</code>, since it actually
places those characters <strong>in between</strong> array elements. So if we have, let’s say,
<code class="highlighter-rouge">10</code> array elements, there are only <code class="highlighter-rouge">9</code> “in-betweens”. Here’s the version
that will work in versions prior to ECMAScript 6:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">isPrime</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/^.</span><span class="se">?</span><span class="sr">$|^</span><span class="se">(</span><span class="sr">..+</span><span class="se">?)\1</span><span class="sr">+$/</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">!</span><span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nb">Array</span><span class="p">(</span><span class="nx">n</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'1'</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<h2 id="perl">Perl</h2>

<p>Last, but not least, it’s time for Perl. I’m including this here because the
regular expression we’ve been exploring in this blog post has been popularized
by Perl. I’m talking about the one-liner <code class="highlighter-rouge">perl -wle 'print "Prime" if (1 x shift) !~ /^1?$|^(11+?)\1+$/' &lt;number&gt;</code>
(replace <code class="highlighter-rouge">&lt;number&gt;</code> with an actual number).</p>

<p>Also, since I haven’t played around with Perl before, this seemed like a good
opportunity to do so. So here we go:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">sub</span> <span class="nx">is_prime</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="p">((</span><span class="mi">1</span><span class="nx">x$_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=~</span> <span class="sr">/^.</span><span class="se">?</span><span class="sr">$|^</span><span class="se">(</span><span class="sr">..+</span><span class="se">?)\1</span><span class="sr">+$/</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Since Perl isn’t the most popular language right now, it might happen that
you’re not familiar with its syntax. Now, I’ve had about 15 mins with it, so
I’m pretty much an expert, so I’ll take the liberty to briefly explain the
syntax above:</p>

<ul>
  <li><code class="highlighter-rouge">sub</code> - defines a new subroutine (function)</li>
  <li><code class="highlighter-rouge">$_[0]</code> - we’re accessing the first parameter passed in to our subroutine</li>
  <li><code class="highlighter-rouge">1x&lt;number&gt;</code> - here we’re using the repetition operator <code class="highlighter-rouge">x</code>, this will
basically repeat the number <code class="highlighter-rouge">1</code> <code class="highlighter-rouge">&lt;number&gt;</code> of times and return the result as a string.
This is similar to what <code class="highlighter-rouge">'1'*&lt;number&gt;</code> would do in Python or <code class="highlighter-rouge">'1'.repeat(&lt;number&gt;)</code>
in JavaScript.</li>
  <li><code class="highlighter-rouge">=~</code> is the match test operator, it will return true if the regular expression
(its right-hand side) has a match on the string (its left-hand side).</li>
  <li><code class="highlighter-rouge">!</code> is the negation operator</li>
</ul>

<p>I included this brief explanation, because, I myself, don’t like being left
in mystery about what a certain passage of code does and the explanation didn’t
take up much space anyways.</p>

<h1 id="conclusion">Conclusion</h1>

<p>That’s all folks! Hopefully, you’re now demystified about how a regular expression
can check if a number is prime. Keep in mind, that this is far from efficient,
there are a lot more efficient algorithms for this task,
but it is, nonetheless, a fun and interesting thing.</p>

<p>I encourage you to go to a website like <a href="https://regex101.com/">regex101</a> and
play around, specially if you’re still not 100% clear about how everything
explained here works. One of the cool things about this website is that
it includes an explanation of the regular expression (column on the right),
as well as the number of steps the regex engine had to make (rectangle right above
the modifiers box) - it’s a good way to see the performance differences (through the number of steps taken)
in the greedy and non-greedy cases.</p>

<p>If you have any questions or suggestions, feel free to post them in the
comment section below or <a href="https://iluxonchik.github.io/about/">get in touch with me via a different medium</a>.</p>

<p><strong>EDIT</strong>:</p>

<ul>
  <li>Thanks to <a href="https://twitter.com/joshuamy">joshuamy</a> for pointing out a typo in
Perl code</li>
  <li>Thanks to <a href="https://disqus.com/by/disqus_kM1gQBMfK7/">Keen</a> for pointing out 
a typo in the post</li>
  <li>Thanks to <a href="https://disqus.com/by/disqus_527bF1C8Ck/">Russel</a> for submitting <a href="https://gist.github.com/iluxonchik/72e8e090fdad0c6468cba5584a7da5fe">a Swift 2 code example</a></li>
  <li>I didn’t want to get into the topic of regular/non-regular languages and related, since
it’s theory that isn’t crucial for the topic of this post, but as <a href="https://www.reddit.com/user/lanzaa/">lanzaa</a>
pointed out, <a href="https://en.m.wikipedia.org/wiki/Regular_expression#Patterns_for_non-regular_languages">there is a difference between “regex” and “regular expression”</a>.
What was covered in this blog post wasn’t a regular expression, but rather a regex.
In the “real world”, however (outside of academia), those terms are used
interchangeably</li>
</ul>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    

    
    
      <li><strong class="current-page">1</strong></li>
    

    
    

    
    
    

    

    
    

    
      <li><a href="https://iluxonchik.github.io/page2/">2</a></li>
    

    
    
      <li><a href="https://iluxonchik.github.io/page2/" class="btn">Next</a></li>
    
  </ul>
</div>


</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2019 Illya Gerasymchuk. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://iluxonchik.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://iluxonchik.github.io/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83065535-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


          

</body>
</html>