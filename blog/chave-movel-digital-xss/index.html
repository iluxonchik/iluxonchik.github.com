<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Chave Móvel Digital Multiple XSS Vulnerabilities &#8211; The Codeumentary</title>
<meta name="description" content="Multiple Reflected Cross-Site-Scripting (XSS) vulnerabilities found in the Portuguese government's Chave Móvel Digital authentication system.">
<meta name="keywords" content="security">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://iluxonchik.github.io/images/">
<meta name="twitter:title" content="Chave Móvel Digital Multiple XSS Vulnerabilities">
<meta name="twitter:description" content="Multiple Reflected Cross-Site-Scripting (XSS) vulnerabilities found in the Portuguese government's Chave Móvel Digital authentication system.">
<meta name="twitter:creator" content="@iluxonchik">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Chave Móvel Digital Multiple XSS Vulnerabilities">
<meta property="og:description" content="Multiple Reflected Cross-Site-Scripting (XSS) vulnerabilities found in the Portuguese government's Chave Móvel Digital authentication system.">
<meta property="og:url" content="https://iluxonchik.github.io/chave-movel-digital-xss/">
<meta property="og:site_name" content="The Codeumentary">





<link rel="canonical" href="https://iluxonchik.github.io/chave-movel-digital-xss/">
<link href="https://iluxonchik.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="The Codeumentary Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://iluxonchik.github.io/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="https://iluxonchik.github.io/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://iluxonchik.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://iluxonchik.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://iluxonchik.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://iluxonchik.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://iluxonchik.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://iluxonchik.github.io/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="https://iluxonchik.github.io/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="https://iluxonchik.github.io/images/avatar.jpg" alt="Illya Gerasymchuk photo" class="author-photo">
					<h4>Illya Gerasymchuk</h4>
					<p>Software Engineer at Mercedes-Benz.io</p>
				</li>
				<li><a href="https://iluxonchik.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:illya@iluxonchik.me"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/iluxonchik"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				
				<li>
					<a href="https://linkedin.com/in/iluxonchik"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/iluxonchik"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				<li>
					<a href="https://instagram.com/iluxonchik.meow"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="https://iluxonchik.github.io/posts/">All Posts</a></li>
				<li><a href="https://iluxonchik.github.io/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="https://iluxonchik.github.io/chave-movel-digital-xss/" rel="bookmark" title="Chave Móvel Digital Multiple XSS Vulnerabilities">Chave Móvel Digital Multiple XSS Vulnerabilities</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2018-05-13T17:00:01+01:00">May 13, 2018</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
Reading time ~3 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <ul>
  <li><a href="/weak-security-of-portuguese-government/">Part 1 - The Weak Security Of The Portuguese Government’s Authentication System</a></li>
  <li><strong>Part 2 - Chave Móvel Digital Multiple XSS Vulnerabilites</strong></li>
  <li><a href="/chave-movel-digital-phone-number-information-leakage">Part 3 - Chave Móvel Digital Phone Number Leakage</a></li>
  <li><a href="/chave-movel-digital-does-not-log-out">Part 4 - Chave Móvel Digital Log Out Not Working</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>In this blog post, I will be exploring the Reflected Cross-Site-Scripting (XSS) vulnerability present in the Portuguese government’s authentication
system’s website <a href="https://www.autenticacao.gov.pt/">www.autenticacao.gov.pt</a>.</p>

<p>The XSS vulnerability is present in the <em>Chave Móvel Digital</em> (CMD) login page.</p>

<h1 id="the-xss-vulnerability">The XSS Vulnerability</h1>

<p>At the moment of writing this post, there are 3 ways that you can authenticate
yourself:</p>

<ul>
  <li>the second-factor code is sent to your mobile phone number</li>
  <li>the second-factor code is sent to your e-mail</li>
  <li>the second-factor code is sent to your as a private Twitter message</li>
</ul>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> Chave Movel Digital Authentication Options</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/auth_opts.png" alt="Chave Movel Digital Authentication Options" /></td></tr>
</table>

<p>I’m going to choose the phone number authentication method, since
this is the only one that’s required. The other two are not activated by
default. The XSS vulnerability seems to only work on the
mobile phone number and Twitter authentication methods. E-mail authentication
seems to be doing input sanitization correctly. There are two separate places where you can login:
the “Personal Area”, which only allows mobile phone number login, and the
regular one, which allows the 3 authentication methods described above.
The XSS vulnerability works in both places.</p>

<p>This is how the main login page looks like:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 2:</b> Digital Mobile Key login page</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/login_page.png" alt="Digital Mobile Key login page" /></td></tr>
</table>

<p>To login to the portal, you need to enter your mobile phone number and a
numeric <code class="highlighter-rouge">PIN</code>. The <code class="highlighter-rouge">Mobile phone number</code> field is the one that will be used
to exploit the <code class="highlighter-rouge">XSS</code> vulnerability. Throughout this section I will be using
<code class="highlighter-rouge">1234</code> as the <code class="highlighter-rouge">PIN</code> number.</p>

<p>Now let’s see what happens when I try to enter a phone number that consists
only of letters (<code class="highlighter-rouge">Hello, World"</code>):</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 3:</b> Digital Mobile Key login page</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/enter_text.png" alt="Digital Mobile Key login page" /></td></tr>
</table>

<p>And now let’s click on “Authenticate”:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 4:</b> User input gets copied without validation</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/enter_text_authenticate.png" alt="User input gets copied without validation" /></td></tr>
</table>

<p>Even though the page says <code class="highlighter-rouge">The phone field only allows numbers</code>, at the bottom, it
still copies the input that I provided verbatim to the same field.
At this point I was pretty sure that the page is vulnerable to <code class="highlighter-rouge">XSS</code>.
So I looked at the source code to see how it can be exploited:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 5:</b> The input is copied to the value attribute</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/value_attr_input.png" alt="The input is copied to the value attribute" /></td></tr>
</table>

<p>Okay, so the input is you provided initially is copied to the <code class="highlighter-rouge">value</code>
attribute of the <code class="highlighter-rouge">inputMobile</code> element. So let’s try to show a very simple
<code class="highlighter-rouge">XSS</code> that would inject a new <code class="highlighter-rouge">span</code> element into the page and would comment
out some of the <code class="highlighter-rouge">HTML</code>. For this, in the <code class="highlighter-rouge">Mobile phone number</code> field, we’ll
input the following text: <code class="highlighter-rouge">" &lt;span&gt; Hello, World &lt;/span&gt; &lt;!--</code>.</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> A simple XSS input</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/xss_input.png" alt="A simple XSS input" /></td></tr>
</table>

<p>And here is the result:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 6:</b> Successful result of an XSS injection</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/xss_result.png" alt="Successful result of an XSS injection" /></td></tr>
</table>

<p>As you can see, our custom <code class="highlighter-rouge">HTML</code>was successfully injected into the page.
The rest of the page wasn’t commented out only because there is another
closing <code class="highlighter-rouge">HTML</code> comment tag (<code class="highlighter-rouge">--&gt;</code>) present in the page’s source.</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> Resulting HTML from the XSS attack</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/xss_source.png" alt="Resulting HTML from the XSS attack" /></td></tr>
</table>

<p>Below is a video demonstration of how this vulnerability can be exploited
to inject arbitrary JavaScript code into the page.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/jG8ZWBNqRyg?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen=""></iframe>

<p>Whenever the text in the “Mobile phone number” field is
changed, the <code class="highlighter-rouge">ShowPrint()</code> function is called. The only thing that it does is
copies the value from the <code class="highlighter-rouge">inputMobile</code> element to the <code class="highlighter-rouge">MainContent_hiddenMobile</code> attribute:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">ShowPrint</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">mobileValue</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"inputMobile"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"MainContent_hiddenMobile"</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">mobileValue</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span></code></pre></figure>

<p>Why this is done is not obvious, since both of the fields get <code class="highlighter-rouge">POST</code>ed to the
the backend when you click on “Authenticate”:</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 1:</b> Both of the attribute values get sent</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/form_data.png" alt="Both of the attribute values get sent" /></td></tr>
</table>

<p>However, if we manually change the value of the <code class="highlighter-rouge">MainContent_hiddenMobile</code>
field to <code class="highlighter-rouge">Hello, Reader</code> and leave <code class="highlighter-rouge">Hello, World</code> in the <code class="highlighter-rouge">inputMobile</code>
field, we can see that the value that that’s placed in the “Mobile phone number” box in the failed login page is the one from <code class="highlighter-rouge">MainContent_hiddenMobile</code>.</p>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 7:</b> Manually changing the value of the hidden input </caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/manual_change.png" alt="Manually changing the value of the hidden input " /></td></tr>
</table>

<style>

IMG.centered {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}

</style>

<table>
    <caption align="bottom"><b>Figure 8:</b> The hidden input value is the one that gets echoed back</caption>
    <tr><td style="max-width: 600px"><img class="centered" src="../images/posts/aut_gov_vuln/manual_change_result.png" alt="The hidden input value is the one that gets echoed back" /></td></tr>
</table>

<h1 id="conclusion">Conclusion</h1>

<p>In this blog post I showed you the <code class="highlighter-rouge">POST</code> XSS vulnerability present
in the Portuguese government’s <code class="highlighter-rouge">autenticacao.gov.pt</code> <em>Chave Móvel Digital</em>
login page.</p>

<p>In the <a href="/chave-movel-digital-phone-number-information-leakage">next blog post</a> I will show you how you can find out if a
mobile phone number is registered with <em>Chave Móvel Digital</em> or not,
making the existing ambiguous “Either the mobile number or the PIN are
incorrect” message useless and opening the door for various social
engineering attacks.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="https://iluxonchik.github.io/tags/#security" title="Pages tagged security" class="tag"><span class="term">security</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://iluxonchik.github.io/chave-movel-digital-xss/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=https://iluxonchik.github.io/chave-movel-digital-xss/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=https://iluxonchik.github.io/chave-movel-digital-xss/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->

       <!-- Social Profile Buttons -->
       
           <a class="github-button" href="https://github.com/iluxonchik" data-style="mega" aria-label="Follow @iluxonchik on GitHub">Follow @iluxonchik</a>
       

       
            <a href="https://twitter.com/iluxonchik" class="twitter-follow-button" data-size="large" data-show-count="false">Follow @iluxonchik</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
       


       
        <a href="http://instagram.com/iluxonchik.meow" title="Illya Gerasymchuk on Instagram" target="_blank">
          <i class="fa fa-instagram" style="font-size:29px;color:black;"></i>
        <span style="color:black;">Instagram</span></a>
       
      <!-- //Social Profile Buttons -->

      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="https://iluxonchik.github.io/weak-security-of-portuguese-government/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="https://iluxonchik.github.io/chave-movel-digital-does-not-log-out/" title="Chave Móvel Digital's Log Out Button Does Not Log The User Out">Chave Móvel Digital's Log Out Button Does Not Log The User Out</a></h3>
      <p>The Log Out button in the Portuguese government's authentication system does not log the user out. This opens a window to unauthorized account access. <a href="https://iluxonchik.github.io/chave-movel-digital-does-not-log-out/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="https://iluxonchik.github.io/chave-movel-digital-phone-number-information-leakage/" title="Chave Móvel Digital Phone Number Leakage">Chave Móvel Digital Phone Number Leakage</a></h4>
        <span>Published on May 13, 2018</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="https://iluxonchik.github.io/weak-security-of-portuguese-government/" title="The Weak Security Of The Portuguese Government's Authentication System">The Weak Security Of The Portuguese Government's Authentication System</a></h4>
        <span>Published on May 13, 2018</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2019 Illya Gerasymchuk. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://iluxonchik.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://iluxonchik.github.io/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83065535-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'iluxonchik'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



    <!-- Social Profile Buttons GitHub -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- //Social Profile Buttons GitHub -->


</body>
</html>
