<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>The Weak Security Of The Portuguese Government's Authentication System &#8211; The Codeumentary</title>
<meta name="description" content="The weak security of Autenticacao.gov.pt and Chave Movel Digital. This is part one of a series of blog posts that explores the weak security and various vulnerabilities found in the Portuguese Government's secure authenticate system.">
<meta name="keywords" content="chave movel digital, cmd, digital mobile key, portugal, authentication, vulnerability">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://iluxonchik.github.io/images/">
<meta name="twitter:title" content="The Weak Security Of The Portuguese Government's Authentication System">
<meta name="twitter:description" content="The weak security of Autenticacao.gov.pt and Chave Movel Digital. This is part one of a series of blog posts that explores the weak security and various vulnerabilities found in the Portuguese Government's secure authenticate system.">
<meta name="twitter:creator" content="@iluxonchik">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="The Weak Security Of The Portuguese Government's Authentication System">
<meta property="og:description" content="The weak security of Autenticacao.gov.pt and Chave Movel Digital. This is part one of a series of blog posts that explores the weak security and various vulnerabilities found in the Portuguese Government's secure authenticate system.">
<meta property="og:url" content="https://iluxonchik.github.io/weak-security-of-portuguese-government/">
<meta property="og:site_name" content="The Codeumentary">





<link rel="canonical" href="https://iluxonchik.github.io/weak-security-of-portuguese-government/">
<link href="https://iluxonchik.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="The Codeumentary Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://iluxonchik.github.io/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="https://iluxonchik.github.io/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://iluxonchik.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://iluxonchik.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://iluxonchik.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://iluxonchik.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://iluxonchik.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://iluxonchik.github.io/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="https://iluxonchik.github.io/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="https://iluxonchik.github.io/images/avatar.png" alt="Illya Gerasymchuk photo" class="author-photo">
					<h4>Illya Gerasymchuk</h4>
					<p>I <3 coding</p>
				</li>
				<li><a href="https://iluxonchik.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:illya@iluxonchik.me"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/iluxonchik"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				
				<li>
					<a href="https://linkedin.com/in/iluxonchik"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/iluxonchik"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				<li>
					<a href="https://instagram.com/iluxonchik.meow"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="https://iluxonchik.github.io/posts/">All Posts</a></li>
				<li><a href="https://iluxonchik.github.io/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="https://iluxonchik.github.io/weak-security-of-portuguese-government/" rel="bookmark" title="The Weak Security Of The Portuguese Government's Authentication System">The Weak Security Of The Portuguese Government's Authentication System</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2018-05-13T17:00:00+01:00">May 13, 2018</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
Reading time ~8 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <ul>
  <li><strong>Part 1 - The Weak Security Of The Portuguese Government’s Authentication System</strong></li>
  <li><a href="/chave-movel-digital-xss">Part 2 - Chave Móvel Digital Multiple XSS Vulnerabilites</a></li>
  <li><a href="/chave-movel-digital-phone-number-information-leakage">Part 3 - Chave Móvel Digital Phone Number Leakage</a></li>
  <li><a href="/chave-movel-digital-does-not-log-out">Part 4 - Chave Móvel Digital Log Out Not Working</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>Back in January 2018, after about half an hour of exploring
the “secure” authentication system provided by the Portuguese government
I found various security issues and vulnerabilities. I will briefly
explore them in a series of blog posts.</p>

<p>In this first blog post I will explain what is <code class="highlighter-rouge">autenticacao.gov.pt</code> and
<em>Chave Móvel Digital</em>, as well as the sensitive information that they
are supposed to be restricting the access too. I will also explore the
overall weak security that the system has.</p>

<p>This whole series of blog posts is a result of my findings in a short
period of time. It’s a compilation of the notes that I took, as a draft
to be submitted to responsible agency, as part of responsible disclosure.
A more thorough security audit is likely to reveal a lot
more problems. If about 30 minutes is all to took to find those problems,
what more would a malicious, motivated attacker would find.</p>

<p>I’m hoping that the issues will be fixed as soon as possible.</p>

<h1 id="responsible-disclosure">Responsible Disclosure</h1>

<p>On January 21st I emailed <code class="highlighter-rouge">ama@ama.pt</code> (email of the responsible agency),
describing the vulnerabilities and security issues, as well as offering
a more detailed description draft and Proof-Of-Concept code, but
obtained no answer.</p>

<h1 id="what-is-autenticacaogovpt-and-chave-movel-digital-cmd">What Is Autenticacao.gov.pt and Chave Movel Digital (CMD)?</h1>

<p><a href="https://autenticacao.gov.pt">Autenticacao.gov.pt’s homepage</a> has the
following text:</p>

<p><code class="highlighter-rouge">
O sítio oficial dos meios de identificação eletrónica,
assinatura digital e autenticação segura do Estado.
</code></p>

<p>which translates to:</p>

<p><code class="highlighter-rouge">
The official site of the means of electronic identification, digital signature
and state's secure authentication.
</code></p>

<p>Basically, it’s an authentication system that allows the Portuguese citizens
to authenticate to administrative public services. Once authenticated, you can, among other things:</p>

<ul>
  <li>register a birth of a child</li>
  <li>register a vehicle</li>
  <li>register a company</li>
  <li>request a birth certificate</li>
  <li>obtain the criminal record of an individual or a company</li>
  <li>submit/consult revenue of an individual or a company</li>
  <li>sign documents</li>
</ul>

<p>New functionalities are constantly added. As you can see, it is a very
useful system, since it allows you to save a lot of time. It allows you
to do many things from the comfort of your home and in minutes, instead
of spending hours at the pubic administrative services.</p>

<p>Despite being very useful, it does expose some sensitive personal
information and allows you to do some sensitive actions. If this
gets into the wrong hands, it can lead to many problems, such as
identity theft.</p>

<p>For this reason, it is very important to have a secure authentication system.
This is what <em>Chave Móvel Digital (CMD)</em>, which translates to Digital
Mobile Key, supposedly does. The main problem with it is that its security
is questionable.</p>

<h1 id="bad-security-from-the-ground-up">Bad Security From The Ground Up</h1>

<p>So now let’s briefly talk about the security of the <em>Chave Móvel Digital</em> authentication system.
In December of 2017 me and <a href="https://www.facebook.com/daria.ianklovich/">my girlfriend</a> went to a Christmas fair. Among other
things, there were various company booths. One of them was VR-related, so
we decided to go in and check it out. After playing around with the Microsoft’s
HoloLens for a little bit, we were approached by a lady there that asked us
if we have already activated the <em>Chave Móvel Digital</em> system. After
explaining to me what that was, she told me that it soon would be mandatory
to have it activated. I could either do it there now or go to the public
administrative organs, wait in queue for hours and do it there.</p>

<p>Motivated by the interest in the security of this new system and the potential
future time savings (bureaucracy is a big issue in Portugal), I decided
to activate it there.</p>

<h3 id="the-authentication-process">The Authentication Process</h3>

<p>Let’s look at the authentication process. To login using the <em>Chave Móvel Digital</em> system you have to enter your
mobile phone number and your PIN. If the entered details are correct, a
code is sent to your mobile number, which you have to enter to login.</p>

<p>The issues here are the following:</p>

<ul>
  <li>PIN can only be 4-8 numeric digits</li>
  <li>SMS as the only second factor authentication option</li>
</ul>

<p>The first one is the most serious one. PIN is essentially your password.
The issue here is that it only be <strong>numeric</strong> its length is <strong>limited</strong> to
be between 4 and 8 characters.</p>

<p>Let’s look at the numbers. <code class="highlighter-rouge">8</code> digit numeric-only passwords means that
there are <code class="highlighter-rouge">10^8 = 100000000</code> possible combinations. This is nothing for
modern computer. For example, let’s see how long will it take to generate
all of the possible combinations on my machine. Assuming that the file
<code class="highlighter-rouge">gen.py</code> contains the following code:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># gen.py file contents</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99999999</span><span class="p">):</span>
    <span class="k">pass</span></code></pre></figure>

<p>Here is what <code class="highlighter-rouge">time python gen.py</code> gives us:</p>

<p>$ time python gen.py
python gen.py  3.20s user 0.01s system 99% cpu 3.208 total</p>

<p>While this is not the most accurate way of measuring the process execution
time, it’s good enough to transmit the idea of how easy this task is for
modern computers. It’s <code class="highlighter-rouge">2018</code> and the Portuguese government
seems to think that 4 to 8 digit passwords are secure.</p>

<p>As an interesting note, when I was signing up with the system, the lady
told me that from her experience people usually choose <code class="highlighter-rouge">4</code> digit PINs, so
that they’re the same as their phone PINs. This seems like a reasonable
assumption to take. In this case, the easy task is made even easier, since
the number of possible combinations is lowered to <code class="highlighter-rouge">10^4 = 10000</code>:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># gen.py file contents</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9999</span><span class="p">):</span>
    <span class="k">pass</span></code></pre></figure>

<p>Here is what <code class="highlighter-rouge">time python gen.py</code> gives us:</p>

<p>$ time python gen.py
python gen.py  0.01s user 0.01s system 98% cpu 0.015 total</p>

<p>Why can’t you use passwords that contain numbers, letters and special
characters? Maybe it’s a legacy issue, but you could definitely write some
middleware that would take care of that. The system is supposed to protect
very sensitive data, after all.</p>

<p>As an example, let me present to you a very simple solution that would make
the system more secure. It would do it so by allowing the users to use
a password that consists of numbers, letters and special characters, while
keeping the core legacy backend unchanged. I’m going to take the following
assumptions:</p>

<ul>
  <li>the backend requires a 4-8 digit <code class="highlighter-rouge">PIN</code></li>
  <li>all of the PINs are stored in plain text</li>
</ul>

<p>A very simple solution would be to do the following:</p>

<ol>
  <li>When the user is registering/changing his password: hash the password provided by the user with the phone number and store it in the database. Generate an digit PIN and store it. This PIN will never be revealed to the user.</li>
  <li>When the users tries to log in: hash the provided password with the phone
number and compare this result to the one that you have stored in the
database.
    <ul>
      <li>if they are equal, send an “OK” to the backend, which will then
  obtain the PIN from the database and use it as needed</li>
      <li>if they are not equal, fail the authentication</li>
    </ul>
  </li>
</ol>

<p>I am in no way suggesting that this is the best solution, because it is not.
It is, however, a very simple one, that would require very little changes
to the overall system and keeping the core legacy backend unchanged.
All you would have to do is add a new table to the database (this way you
  will keep your existing tables unchanged) for the password hash and
change the authentication code in the middlware between the client and the
backend system. Even if the system is different from the one in my assumptions,
you can adopt the solution with relative ease.</p>

<p>The second point relates to only allowing SMS as the second-factor
authentication. While being a lot better than not using two-factor
authentication at all, it’s not the most secure option.
Let me give you two examples. By using some social engineering, if an attacker
can get access to your personal information, they can contact your phone
company and move your phone number to a new SIM. By exploiting the <a href="https://www.theguardian.com/technology/2016/apr/19/ss7-hack-explained-mobile-phone-vulnerability-snooping-texts-calls">vulnerabilities in the
SS7 protocol</a> the attacker can
read all of your text messages.</p>

<p>Allowing the use of other authentication options, such as Google Authenticator
would make the second-factor authentication a lot more secure. In general,
I have a feeling that the engineers assumed that there was no need for
strong passwords, since two-factor authentication is required and
only the user has the access to his mobile phone number. This assumption
is, of course, incorrect. While it is true, that if you’re using a <strong>good
second-factor authentication</strong>, it’s safe to weaken your password,
this does not apply to making your password a trivial 4-8 digit one.</p>

<p>Now, this just smelled <strong>bad security</strong>. I was certain that I could more problems. I was correct. The security issues that I’m going to be describing in this series of blog posts were found after about 30 minutes of
exploring.</p>

<p>There is now an option to receive your second-factor code
as a private message on Twitter or be sent to your e-mail address. Those
are not enabled by default and you have to do it yourself. I am not
sure when those options were added. In any case,
when logging in into your “Personal Area”, you only have the option of
using your mobile phone number.</p>

<h1 id="conclusion">Conclusion</h1>

<p>In this first post of the four-part series I described why the security
of the authentication system is flawed. This is also what motivated me
to explore further: I was sure that it wouldn’t be hard to find more issues,
since the “security” of this “secure authentication system” did seem
like an afterthought.</p>

<p>In the <a href="/chave-movel-digital-xss">next blog post</a>, I will be describing the multiple XSS vulnerabilities
present in the authentication page.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="https://iluxonchik.github.io/tags/#chave movel digital" title="Pages tagged chave movel digital" class="tag"><span class="term">chave movel digital</span></a><a href="https://iluxonchik.github.io/tags/#cmd" title="Pages tagged cmd" class="tag"><span class="term">cmd</span></a><a href="https://iluxonchik.github.io/tags/#digital mobile key" title="Pages tagged digital mobile key" class="tag"><span class="term">digital mobile key</span></a><a href="https://iluxonchik.github.io/tags/#portugal" title="Pages tagged portugal" class="tag"><span class="term">portugal</span></a><a href="https://iluxonchik.github.io/tags/#authentication" title="Pages tagged authentication" class="tag"><span class="term">authentication</span></a><a href="https://iluxonchik.github.io/tags/#vulnerability" title="Pages tagged vulnerability" class="tag"><span class="term">vulnerability</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://iluxonchik.github.io/weak-security-of-portuguese-government/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=https://iluxonchik.github.io/weak-security-of-portuguese-government/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=https://iluxonchik.github.io/weak-security-of-portuguese-government/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->

       <!-- Social Profile Buttons -->
       
           <a class="github-button" href="https://github.com/iluxonchik" data-style="mega" aria-label="Follow @iluxonchik on GitHub">Follow @iluxonchik</a>
       

       
            <a href="https://twitter.com/iluxonchik" class="twitter-follow-button" data-size="large" data-show-count="false">Follow @iluxonchik</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
       


       
        <a href="http://instagram.com/iluxonchik.meow" title="Illya Gerasymchuk on Instagram" target="_blank">
          <i class="fa fa-instagram" style="font-size:29px;color:black;"></i>
        <span style="color:black;">Instagram</span></a>
       
      <!-- //Social Profile Buttons -->

      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="https://iluxonchik.github.io/regular-expression-check-if-number-is-prime/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="https://iluxonchik.github.io/chave-movel-digital-does-not-log-out/" title="Chave Móvel Digial's Log Out Button Does Not Log The User Out">Chave Móvel Digial's Log Out Button Does Not Log The User Out</a></h3>
      <p>The Log Out button in the Portuguese government's authentication system does not log the user out. This opens a window to unauthorized account access. <a href="https://iluxonchik.github.io/chave-movel-digital-does-not-log-out/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="https://iluxonchik.github.io/chave-movel-digital-phone-number-information-leakage/" title="Chave Móvel Digital Phone Number Leakage">Chave Móvel Digital Phone Number Leakage</a></h4>
        <span>Published on May 13, 2018</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="https://iluxonchik.github.io/chave-movel-digital-xss/" title="Chave Móvel Digital Multiple XSS Vulnerabilities">Chave Móvel Digital Multiple XSS Vulnerabilities</a></h4>
        <span>Published on May 13, 2018</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2018 Illya Gerasymchuk. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://iluxonchik.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://iluxonchik.github.io/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83065535-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'iluxonchik'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



    <!-- Social Profile Buttons GitHub -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- //Social Profile Buttons GitHub -->


</body>
</html>
